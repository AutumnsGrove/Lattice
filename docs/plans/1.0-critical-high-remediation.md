# Grove 1.0 Critical & High Priority Remediation Plan

**Created**: January 8, 2026
**Priority**: P0 (Critical) + P1 (High)
**Total Issues**: 30
**Estimated Effort**: ~19 hours

---

## Execution Strategy

This plan is structured for parallel agent execution. Each agent owns a functional area and fixes all Critical/High issues within that domain. Agents must run tests after each fix.

### Dependency Order

Some agents have dependencies and must complete before others can start:

```
Phase 1 (Parallel):
├── Agent 1: Content Security (P0 - blocks other content work)
├── Agent 2: Storage Security (P0 - tenant isolation)
├── Agent 6: Analytics Privacy (P0 - PII removal)
└── Agent 9: Build & CI (P1 - enables testing)

Phase 2 (After Phase 1):
├── Agent 3: Authentication (P1 - depends on testing infra)
├── Agent 4: Core Infrastructure (P1)
└── Agent 5: Social & Federation (P1)

Phase 3 (After Phase 2):
└── Agent 7: UI Components (P1 - a11y fixes)
```

---

## Agent 1: Content Security Fixes

**Priority**: P0 (CRITICAL - XSS vulnerabilities)
**Files**: 4 files, 6 issues
**Estimated Time**: 4 hours

### Critical Issues (3)

#### Issue 1.1: SSR Sanitization Bypass
**File**: `/home/user/GroveEngine/packages/engine/src/lib/utils/sanitize.ts`
**Lines**: 34-36, 86-89, 188-190
**Problem**: All sanitization functions return unsanitized HTML during SSR

**Fix Steps**:
1. Install `isomorphic-dompurify` or implement Workers-compatible sanitizer
2. Replace browser-only DOMPurify with isomorphic version
3. Remove the `if (!BROWSER || !DOMPurify)` early returns
4. Ensure sanitization runs on both server and client

**Test**:
```bash
cd packages/engine && pnpm test:run
# Manually test: Create post with <script>alert('xss')</script> in markdown
# Verify: Script tag stripped in both SSR HTML and hydrated content
```

#### Issue 1.2: Blog Posts Not Sanitized
**File**: `/home/user/GroveEngine/packages/engine/src/lib/utils/markdown.ts`
**Lines**: 310-327
**Problem**: `parseMarkdownContent()` doesn't call sanitization

**Fix Steps**:
1. Modify `parseMarkdownContent()` to call `sanitizeMarkdown()` before returning
2. Or: Rename to `parseMarkdownContentUnsafe()` and update all callers to use sanitized version
3. Audit all usages of `parseMarkdownContent()` and ensure none render user content

**Test**:
```bash
# Grep for all usages
grep -r "parseMarkdownContent" packages/engine/src/
# Verify each usage is either internal/trusted or now uses sanitized version
```

#### Issue 1.3: Recursive Markdown Rendering XSS
**File**: `/home/user/GroveEngine/packages/engine/src/lib/utils/markdown.ts`
**Lines**: 186-212
**Problem**: Code blocks with `markdown`/`md` language recursively parse without sanitization

**Fix Steps**:
1. Remove recursive markdown rendering in code blocks, OR
2. Apply `sanitizeMarkdown()` to the recursively-rendered content
3. Add depth limit to prevent infinite recursion attacks

**Test**:
```bash
# Create test post with nested markdown code blocks
# Verify: No script execution, no infinite loops
```

### High Issues (3)

#### Issue 1.4: Async DOMPurify Race Condition
**File**: `/home/user/GroveEngine/packages/engine/src/lib/components/custom/ContentWithGutter.svelte`
**Lines**: 434-485, 560
**Problem**: Content renders before DOMPurify loads

**Fix Steps**:
1. Show loading state until DOMPurify is ready
2. Or: Bundle DOMPurify synchronously instead of dynamic import
3. Never render `{@html}` content until sanitizer is confirmed ready

#### Issue 1.5: Gutter Sanitization Broken
**File**: `/home/user/GroveEngine/packages/engine/src/lib/components/custom/GutterItem.svelte`
**Lines**: 4, 42
**Problem**: Relies on broken `sanitizeHTML()` function

**Fix Steps**:
1. This will be fixed by Issue 1.1 (SSR sanitization)
2. Verify gutter content is sanitized after Issue 1.1 fix

#### Issue 1.6: GFM Allows Raw HTML + Data Attributes
**File**: `/home/user/GroveEngine/packages/engine/src/lib/utils/markdown.ts`
**Lines**: 237-241
**File**: `/home/user/GroveEngine/packages/engine/src/lib/components/custom/ContentWithGutter.svelte`
**Line**: 482

**Fix Steps**:
1. Set `ALLOW_DATA_ATTR: false` in DOMPurify config
2. Document why GFM is needed, or disable if not required
3. Ensure sanitization strips any dangerous HTML from GFM output

**Verification After All Content Fixes**:
```bash
cd packages/engine
pnpm test:run
pnpm build
# Manual XSS test suite:
# - Script tags in markdown
# - Event handlers in HTML
# - Data attribute attacks
# - Nested markdown code blocks
# - SVG with embedded scripts
```

---

## Agent 2: Storage Security Fixes

**Priority**: P0 (CRITICAL - Cross-tenant data access)
**Files**: 5 files, 6 issues
**Estimated Time**: 3 hours

### Critical Issues (3)

#### Issue 2.1: No Tenant Isolation in R2 Paths
**File**: `/home/user/GroveEngine/packages/engine/src/routes/api/images/upload/+server.ts`
**Lines**: 150, 167
**Problem**: Files stored without tenant ID prefix

**Fix Steps**:
1. Modify key generation at line 150:
   ```typescript
   const key = `${locals.tenantId}/${datePath}/${filename}`;
   ```
2. Update CDN URL generation at line 167 to include tenant path
3. Consider migration strategy for existing files (document, don't block launch)

**Test**:
```bash
# Upload image as tenant A
# Verify R2 key starts with tenant A's ID
# Attempt to access via tenant B's context - should fail
```

#### Issue 2.2: No Ownership Verification on Delete
**File**: `/home/user/GroveEngine/packages/engine/src/routes/api/images/delete/+server.js`
**Lines**: 62-68
**Problem**: Any authenticated user can delete any file

**Fix Steps**:
1. After line 62, add ownership check:
   ```javascript
   // Query metadata to verify ownership
   const fileRecord = await platform.env.DB.prepare(
     'SELECT tenant_id FROM image_hashes WHERE key = ?'
   ).bind(sanitizedKey).first();

   if (!fileRecord || fileRecord.tenant_id !== locals.tenantId) {
     throw error(403, 'Access denied');
   }
   ```
2. If no metadata table exists, create one or use R2 custom metadata

#### Issue 2.3: No Tenant Filtering in R2 List
**File**: `/home/user/GroveEngine/packages/engine/src/routes/api/images/list/+server.ts`
**Lines**: 62-66
**Problem**: List operation doesn't scope to tenant

**Fix Steps**:
1. Force prefix to start with tenant ID:
   ```typescript
   const tenantPrefix = `${locals.tenantId}/`;
   const requestedPrefix = url.searchParams.get("prefix") || "";
   const prefix = tenantPrefix + requestedPrefix;
   ```
2. Update line 50 and lines 62-66 to use scoped prefix

### High Issues (3)

#### Issue 2.4: Stream Leak in getFile()
**File**: `/home/user/GroveEngine/packages/engine/src/lib/server/services/storage.ts`
**Lines**: 375-391
**Problem**: ReadableStream not guaranteed to be closed

**Fix Steps**:
1. Add timeout wrapper around returned stream
2. Document that callers MUST consume stream
3. Consider adding cleanup in `finally` block

#### Issue 2.5: Inconsistent File Size Limits
**File**: `/home/user/GroveEngine/packages/engine/src/routes/api/images/upload/+server.ts`
**Lines**: 24, 67-69
**File**: `/home/user/GroveEngine/packages/engine/src/lib/server/services/storage.ts`
**Problem**: Upload uses 10MB, storage service defaults to 50MB

**Fix Steps**:
1. Standardize on 10MB for images
2. Pass `maxFileSize` option to storage service from upload endpoint
3. Document the limit in API docs

#### Issue 2.6: Unbounded R2 List Scan
**File**: `/home/user/GroveEngine/packages/engine/src/routes/api/images/filters/+server.ts`
**Lines**: 44-68
**Problem**: No maximum iteration limit

**Fix Steps**:
1. Add iteration counter:
   ```typescript
   let iterations = 0;
   const MAX_ITERATIONS = 20;
   do {
     if (++iterations > MAX_ITERATIONS) break;
     // ... existing loop body
   } while (cursor);
   ```

**Verification After All Storage Fixes**:
```bash
cd packages/engine
pnpm test:run
# Manual tests:
# - Upload as tenant A, verify path includes tenant ID
# - Try to delete tenant A's file as tenant B - should fail
# - Try to list tenant A's files as tenant B - should return empty
# - Upload file > 10MB - should fail
```

---

## Agent 3: Authentication Fixes

**Priority**: P1 (HIGH)
**Files**: 3 files, 4 issues
**Estimated Time**: 3 hours

### High Issues (4)

#### Issue 3.1: Hardcoded Production Domain in Cookie
**File**: `/home/user/GroveEngine/landing/src/routes/auth/callback/+server.ts`
**Lines**: 126-134
**Problem**: Sets `domain: ".grove.place"` unconditionally

**Fix Steps**:
1. Check hostname before setting domain:
   ```typescript
   const domain = url.hostname.endsWith('.grove.place')
     ? '.grove.place'
     : undefined;
   ```
2. Match pattern used in engine callback at lines 282-284

#### Issue 3.2: Weak Turnstile Cookie Signing
**File**: `/home/user/GroveEngine/packages/engine/src/lib/server/services/turnstile.ts`
**Lines**: 147-155
**Problem**: Uses non-cryptographic hash for security-critical cookie

**Fix Steps**:
1. Replace `simpleHash()` with HMAC-SHA256:
   ```typescript
   async function signCookie(value: string, secret: string): Promise<string> {
     const encoder = new TextEncoder();
     const key = await crypto.subtle.importKey(
       'raw',
       encoder.encode(secret),
       { name: 'HMAC', hash: 'SHA-256' },
       false,
       ['sign']
     );
     const signature = await crypto.subtle.sign(
       'HMAC',
       key,
       encoder.encode(value)
     );
     return btoa(String.fromCharCode(...new Uint8Array(signature)));
   }
   ```
2. Update cookie verification to use HMAC verify

#### Issue 3.3: No Server-Side Rate Limiting on Auth
**File**: Multiple auth endpoints
**Problem**: Only client-side rate limiting exists (bypassable)

**Fix Steps**:
1. Add rate limiting middleware to:
   - `/auth/login/start`
   - `/auth/callback`
   - Token refresh endpoints
2. Use Cloudflare Workers rate limiting or implement via KV/DO
3. Limit: 5 failed attempts per 15 minutes per IP

#### Issue 3.4: Verbose Error Logging Exposes Config
**File**: `/home/user/GroveEngine/packages/engine/src/routes/auth/callback/+server.ts`
**Lines**: 198-213
**Problem**: Logs authApiUrl, clientId, hasSecret, redirectUri

**Fix Steps**:
1. Reduce production logging to error codes only
2. Use structured logger with log levels
3. Move detailed logging behind `DEV` flag

**Verification**:
```bash
cd packages/engine && pnpm test:run
cd landing && pnpm test:run
# Manual tests:
# - Auth flow works on localhost
# - Cookie domain correct for .grove.place
# - Rapid login attempts get rate limited
```

---

## Agent 4: Core Infrastructure Fixes

**Priority**: P1 (HIGH)
**Files**: 3 files, 3 issues
**Estimated Time**: 2 hours

### High Issues (3)

#### Issue 4.1: DatabaseErrorCode Type Mismatch
**File**: `/home/user/GroveEngine/packages/engine/src/lib/server/services/database.ts`
**Lines**: 732, 737, and type definition at 63-69
**Problem**: Using 'VALIDATION_ERROR' which isn't in the union type

**Fix Steps**:
1. Add 'VALIDATION_ERROR' to DatabaseErrorCode union at lines 63-69:
   ```typescript
   type DatabaseErrorCode =
     | 'QUERY_FAILED'
     | 'NOT_FOUND'
     | 'CONSTRAINT_VIOLATION'
     | 'TRANSACTION_FAILED'
     | 'CONNECTION_ERROR'
     | 'INVALID_QUERY'
     | 'VALIDATION_ERROR';  // Add this
   ```
2. Or change lines 732/737 to use 'INVALID_QUERY' if semantically appropriate

#### Issue 4.2: Any Type in Ref Property
**File**: `/home/user/GroveEngine/packages/engine/src/lib/utils.ts`
**Line**: 9
**Problem**: `ref?: any` bypasses type checking

**Fix Steps**:
1. Replace with proper typing:
   ```typescript
   type WithElementRef<T, E extends HTMLElement = HTMLElement> = T & {
     ref?: E | null;
   };
   ```
2. Update any usages that depend on the loose typing

#### Issue 4.3: Unvalidated API Response Assertions
**File**: `/home/user/GroveEngine/packages/engine/src/hooks.server.ts`
**Lines**: 231-240, 270-276
**Problem**: Type assertions without runtime validation

**Fix Steps**:
1. Add runtime validation before type assertion:
   ```typescript
   const data = await response.json();
   if (!data || typeof data.userId !== 'string') {
     throw new Error('Invalid API response');
   }
   const validatedData = data as ExpectedType;
   ```
2. Consider using zod for schema validation

**Verification**:
```bash
cd packages/engine
pnpm check  # TypeScript type checking
pnpm test:run
pnpm build
```

---

## Agent 5: Social & Federation Fixes

**Priority**: P1 (HIGH)
**Files**: 2 files, 2 issues
**Estimated Time**: 2 hours

### High Issues (2)

#### Issue 5.1: RSS Feed Hardcoded URL
**File**: `/home/user/GroveEngine/packages/engine/src/routes/api/feed/+server.ts`
**Line**: 15
**Problem**: Hardcoded "https://autumnsgrove.com" instead of tenant URL

**Fix Steps**:
1. Replace hardcoded URL with dynamic tenant URL:
   ```typescript
   const siteUrl = event.locals.context?.type === 'tenant'
     ? `https://${event.locals.context.tenant.subdomain}.grove.place`
     : 'https://grove.place';
   ```
2. Update all other hardcoded URLs in the feed

#### Issue 5.2: CSRF Allows Cross-Tenant Attacks
**File**: `/home/user/GroveEngine/packages/engine/src/lib/utils/csrf.js`
**Line**: 71
**Problem**: Any `*.grove.place` subdomain can make requests

**Fix Steps**:
1. Tighten validation to require same-origin OR explicit cross-tenant allowlist:
   ```javascript
   // Remove blanket .grove.place exception
   // Require exact host match for CSRF-protected endpoints
   const isSameOrigin = originUrl.hostname === hostUrl.hostname;
   if (!isSameOrigin && !isLocalhost) {
     return false;
   }
   ```
2. If cross-subdomain requests needed, implement explicit CORS + token verification

**Verification**:
```bash
cd packages/engine && pnpm test:run
# Manual tests:
# - RSS feed shows correct tenant URL
# - CSRF rejects requests from other subdomains
```

---

## Agent 6: Analytics Privacy Fixes

**Priority**: P0 (CRITICAL - PII exposure)
**Files**: 2 files, 3 issues
**Estimated Time**: 2 hours

### Critical Issues (1)

#### Issue 6.1: PII Logged in Auth Callback
**File**: `/home/user/GroveEngine/packages/engine/src/routes/auth/callback/+server.ts`
**Lines**: 265, 272
**Problem**: User email logged to console

**Fix Steps**:
1. Remove email from console.log at line 265:
   ```typescript
   // Before: console.log("[Auth Callback] User upserted:", userInfo.email)
   console.log("[Auth Callback] User upserted:", userInfo.sub);
   ```
2. Remove email from error logging at line 272
3. Grep for other instances: `grep -r "userInfo.email" packages/`

### High Issues (2)

#### Issue 6.2: Logger Uses Console Directly
**File**: `/home/user/GroveEngine/packages/engine/src/lib/server/logger.ts`
**Lines**: 190-191, 206-211, 236
**Problem**: No centralized logging pipeline

**Fix Steps**:
1. Add production flag to disable console output
2. Add option for external logging service integration
3. Ensure all console calls can be redirected

#### Issue 6.3: Webhook Payloads Stored Without Cleanup
**File**: `/home/user/GroveEngine/packages/engine/src/routes/api/shop/webhooks/+server.ts`
**Lines**: 79-91
**Problem**: Full Stripe events with PII stored indefinitely

**Fix Steps**:
1. Add TTL/cleanup policy for webhook_events table
2. Sanitize payloads before storage (remove customer PII)
3. Or: Store only event ID and type, fetch details from Stripe when needed

**Verification**:
```bash
cd packages/engine && pnpm test:run
# Manual verification:
# - Auth flow doesn't log emails
# - Check console output for PII
grep -r "console.log" packages/engine/src/routes/auth/
```

---

## Agent 7: UI Accessibility Fixes

**Priority**: P1 (HIGH)
**Files**: 6 files, 7 issues
**Estimated Time**: 3 hours

### Critical Issues (2)

#### Issue 7.1: SearchInput Missing Label
**File**: `/home/user/GroveEngine/packages/engine/src/lib/ui/components/forms/SearchInput.svelte`
**Lines**: 48-57
**Problem**: Textarea has no accessible label

**Fix Steps**:
1. Add aria-label to textarea:
   ```svelte
   <textarea
     aria-label="Search query"
     ...existing props
   />
   ```
2. Or add visible label with proper `for` attribute

#### Issue 7.2: MarkdownEditor Missing Label
**File**: `/home/user/GroveEngine/packages/engine/src/lib/components/admin/MarkdownEditor.svelte`
**Lines**: 579-592
**Problem**: Main textarea lacks accessible label

**Fix Steps**:
1. Add aria-label to textarea:
   ```svelte
   <textarea
     aria-label="Markdown editor content"
     ...existing props
   />
   ```

### High Issues (5)

#### Issue 7.3: Lightbox Keyboard Navigation
**File**: `/home/user/GroveEngine/packages/engine/src/lib/ui/components/gallery/Lightbox.svelte`
**Lines**: 27-50
**Problem**: Suppressed a11y warnings without proper keyboard handlers

**Fix Steps**:
1. Remove `svelte-ignore` comments
2. Verify keyboard handlers work correctly
3. Add focus trap for modal

#### Issue 7.4: ImageGallery A11y Suppression
**File**: `/home/user/GroveEngine/packages/engine/src/lib/ui/components/gallery/ImageGallery.svelte`
**Lines**: 163-172, 266-296
**Problem**: Multiple suppressed a11y warnings

**Fix Steps**:
1. Review each `svelte-ignore` and implement proper fix
2. Ensure keyboard navigation for all interactive elements

#### Issue 7.5: OnboardingChecklist Dismiss Button
**File**: `/home/user/GroveEngine/packages/engine/src/lib/components/OnboardingChecklist.svelte`
**Lines**: 32-38
**Problem**: Button has only title, missing aria-label

**Fix Steps**:
1. Add aria-label:
   ```svelte
   <button
     aria-label="Dismiss getting started checklist"
     title="Dismiss"
     ...
   />
   ```

#### Issue 7.6: ZoomableImage Role Misuse
**File**: `/home/user/GroveEngine/packages/engine/src/lib/ui/components/gallery/ZoomableImage.svelte`
**Lines**: 139-157
**Problem**: Image has `role="button"` which is incorrect

**Fix Steps**:
1. Wrap image in proper button:
   ```svelte
   <button
     onclick={handleClick}
     onkeydown={handleKeydown}
     aria-label="Click to zoom image"
     class="zoom-button"
   >
     <img {src} {alt} ... />
   </button>
   ```

#### Issue 7.7: Canvas A11y Suppression
**File**: `/home/user/GroveEngine/packages/engine/src/lib/ui/components/terrarium/Canvas.svelte`
**Lines**: 178-179
**Problem**: Interactive div suppresses a11y warnings

**Fix Steps**:
1. Use semantic `<canvas>` element
2. Add proper ARIA labels for assistive technology
3. Document keyboard controls if applicable

**Verification**:
```bash
cd packages/engine && pnpm build
# Run accessibility audit
npx axe-core packages/engine
# Manual screen reader testing
```

---

## Agent 9: Build & CI Fixes

**Priority**: P1 (HIGH - enables testing)
**Files**: Multiple workflows + configs
**Estimated Time**: 2 hours

### High Issues (4)

#### Issue 9.1: No Tests in CI Before Deploy
**Files**: All `.github/workflows/deploy-*.yml`
**Problem**: Deployments don't run tests

**Fix Steps**:
1. Add test step to each deployment workflow:
   ```yaml
   - name: Run tests
     run: pnpm test:run
     working-directory: <package-dir>

   - name: Type check
     run: pnpm check
     working-directory: <package-dir>
   ```
2. Ensure deployment only proceeds if tests pass

#### Issue 9.2: Wrangler Version Inconsistency
**Files**:
- `/home/user/GroveEngine/packages/grove-router/package.json`
- `/home/user/GroveEngine/packages/og-worker/package.json`
**Problem**: Using ^3.99.0 while others use ^4.54.0

**Fix Steps**:
1. Update both to `"wrangler": "^4.54.0"`
2. Run `pnpm install` to update lockfile
3. Test that builds still work

#### Issue 9.3: No .nvmrc File
**File**: Root directory
**Problem**: No Node version specification for local dev

**Fix Steps**:
1. Create `/home/user/GroveEngine/.nvmrc`:
   ```
   20
   ```

#### Issue 9.4: Vulnerable qs Dependency
**Problem**: Transitive dependency with DoS vulnerability

**Fix Steps**:
1. Add to root package.json pnpm overrides:
   ```json
   "pnpm": {
     "overrides": {
       "qs": ">=6.14.1"
     }
   }
   ```
2. Run `pnpm install` to update

**Verification**:
```bash
pnpm install
pnpm -r build
pnpm -r test:run
# Verify CI workflow changes locally with act or similar
```

---

## Post-Fix Verification Checklist

After all agents complete, run this verification:

```bash
# 1. Full type check
pnpm -r check

# 2. Full test suite
pnpm -r test:run

# 3. Build all packages
pnpm -r build

# 4. Security audit
pnpm audit

# 5. Manual XSS testing
# - Create post with malicious content
# - Verify sanitization in SSR and client

# 6. Cross-tenant testing
# - Upload as tenant A
# - Try to access/delete as tenant B

# 7. Accessibility testing
npx axe-core packages/engine
```

---

## Summary

| Agent | Area | Critical | High | Est. Time |
|-------|------|----------|------|-----------|
| 1 | Content Security | 3 | 3 | 4h |
| 2 | Storage Security | 3 | 3 | 3h |
| 3 | Authentication | 0 | 4 | 3h |
| 4 | Core Infrastructure | 0 | 3 | 2h |
| 5 | Social & Federation | 0 | 2 | 2h |
| 6 | Analytics Privacy | 1 | 2 | 2h |
| 7 | UI Accessibility | 2 | 5 | 3h |
| 9 | Build & CI | 0 | 4 | 2h |
| **Total** | | **9** | **26** | **21h** |

*Note: Agent 8 (Durable Objects) has no issues - DOs are not yet implemented.*
