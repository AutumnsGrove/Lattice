# Grove 1.0 Critical & High Priority Remediation Plan

**Created**: January 8, 2026
**Priority**: P0 (Critical) + P1 (High)
**Total Issues**: 30
**Estimated Effort**: ~19 hours

---

## Execution Strategy

This plan is structured for parallel agent execution. Each agent owns a functional area and fixes all Critical/High issues within that domain. Agents must run tests after each fix.

### Dependency Order

Some agents have dependencies and must complete before others can start:

```
Phase 1 (Parallel):
├── Agent 1: Content Security (P0 - blocks other content work)
├── Agent 2: Storage Security (P0 - tenant isolation)
├── Agent 6: Analytics Privacy (P0 - PII removal)
└── Agent 9: Build & CI (P1 - enables testing)

Phase 2 (After Phase 1):
├── Agent 3: Authentication (P1 - depends on testing infra)
├── Agent 4: Core Infrastructure (P1)
└── Agent 5: Social & Federation (P1)

Phase 3 (After Phase 2):
└── Agent 7: UI Components (P1 - a11y fixes)
```

---

## ~~Agent 1: Content Security Fixes~~ ✅ ALL FIXED

**Priority**: P0 (CRITICAL - XSS vulnerabilities)
**Status**: ✅ All 6 issues already resolved (verified January 2026)

### Summary of Fixes Already Implemented

#### ~~Issue 1.1: SSR Sanitization Bypass~~ ✅ FIXED
**Solution**: `sanitize.ts` now has `sanitizeServerSafe()` regex-based fallback (lines 33-94) that runs when DOMPurify isn't available (SSR/Workers). All three sanitization functions call this fallback.

#### ~~Issue 1.2: Blog Posts Not Sanitized~~ ✅ FIXED
**Solution**: `parseMarkdownContent()` at line 342 now calls `sanitizeMarkdown(htmlContent)` before returning. All page loaders use sanitized content.

#### ~~Issue 1.3: Recursive Markdown Rendering XSS~~ ✅ FIXED
**Solution**: `markdown.ts` line 213 wraps recursive markdown rendering in `sanitizeMarkdown()`.

#### ~~Issue 1.4: Async DOMPurify Race Condition~~ ✅ FIXED
**Solution**: `ContentWithGutter.svelte` lines 431-445 sets `isPurifyReady = true` immediately since content is already server-sanitized. DOMPurify loads in background for additional defense.

#### ~~Issue 1.5: Gutter Sanitization Broken~~ ✅ FIXED
**Solution**: `GutterItem.svelte` line 50 uses `sanitizeHTML(item.content)` which now works via the server-safe fallback.

#### ~~Issue 1.6: GFM Allows Raw HTML + Data Attributes~~ ✅ FIXED
**Solution**: `ContentWithGutter.svelte` line 490 sets `ALLOW_DATA_ATTR: false` and explicitly whitelists only safe data attributes (`data-anchor`, `data-language`, `data-line-numbers`, `data-code`).

---

## ~~Agent 2: Storage Security Fixes~~ ✅ ALL FIXED

**Priority**: P0 (CRITICAL - Cross-tenant data access)
**Status**: ✅ All 6 issues already resolved (verified January 2026)

### Summary of Fixes Already Implemented

#### ~~Issue 2.1: No Tenant Isolation in R2 Paths~~ ✅ FIXED
**Solution**: `upload/+server.ts` line 304 includes tenant in path: `const key = \`${tenantId}/${datePath}/${filename}\`;`

#### ~~Issue 2.2: No Ownership Verification on Delete~~ ✅ FIXED
**Solution**: `delete/+server.ts` lines 96-103 validate key starts with `${tenantId}/` prefix and returns 403 on mismatch.

#### ~~Issue 2.3: No Tenant Filtering in R2 List~~ ✅ FIXED
**Solution**: `list/+server.ts` lines 77-79 force tenant prefix: `const tenantPrefix = \`${tenantId}/\`; const prefix = tenantPrefix + requestedPrefix;`

#### ~~Issue 2.4: Stream Leak in getFile()~~ ✅ FIXED
**Solution**: `storage.ts` lines 400-418 have comprehensive JSDoc documentation warning that streams MUST be consumed.

#### ~~Issue 2.5: Inconsistent File Size Limits~~ ✅ FIXED
**Solution**: `storage.ts` lines 113, 249-256 implement `DEFAULT_MAX_FILE_SIZE = 10MB` with `validateFile()` function. Content type validation also blocks dangerous types (SVG removed line 136).

#### ~~Issue 2.6: Unbounded R2 List Scan~~ ✅ FIXED
**Solution**: `filters/+server.ts` lines 52-62 implement `MAX_ITERATIONS = 20` limit (20 × 500 = 10,000 max images).

---

## Agent 3: Authentication Fixes

**Priority**: P1 (HIGH)
**Files**: 3 files, 4 issues
**Estimated Time**: 3 hours

### High Issues (4)

#### Issue 3.1: Hardcoded Production Domain in Cookie
**File**: `/home/user/GroveEngine/landing/src/routes/auth/callback/+server.ts`
**Lines**: 126-134
**Problem**: Sets `domain: ".grove.place"` unconditionally

**Fix Steps**:
1. Check hostname before setting domain:
   ```typescript
   const domain = url.hostname.endsWith('.grove.place')
     ? '.grove.place'
     : undefined;
   ```
2. Match pattern used in engine callback at lines 282-284

#### Issue 3.2: Weak Turnstile Cookie Signing
**File**: `/home/user/GroveEngine/packages/engine/src/lib/server/services/turnstile.ts`
**Lines**: 147-155
**Problem**: Uses non-cryptographic hash for security-critical cookie

**Fix Steps**:
1. Replace `simpleHash()` with HMAC-SHA256:
   ```typescript
   async function signCookie(value: string, secret: string): Promise<string> {
     const encoder = new TextEncoder();
     const key = await crypto.subtle.importKey(
       'raw',
       encoder.encode(secret),
       { name: 'HMAC', hash: 'SHA-256' },
       false,
       ['sign']
     );
     const signature = await crypto.subtle.sign(
       'HMAC',
       key,
       encoder.encode(value)
     );
     return btoa(String.fromCharCode(...new Uint8Array(signature)));
   }
   ```
2. Update cookie verification to use HMAC verify

#### Issue 3.3: No Server-Side Rate Limiting on Auth
**File**: Multiple auth endpoints
**Problem**: Only client-side rate limiting exists (bypassable)

**Fix Steps**:
1. Add rate limiting middleware to:
   - `/auth/login/start`
   - `/auth/callback`
   - Token refresh endpoints
2. Use Cloudflare Workers rate limiting or implement via KV/DO
3. Limit: 5 failed attempts per 15 minutes per IP

#### Issue 3.4: Verbose Error Logging Exposes Config
**File**: `/home/user/GroveEngine/packages/engine/src/routes/auth/callback/+server.ts`
**Lines**: 198-213
**Problem**: Logs authApiUrl, clientId, hasSecret, redirectUri

**Fix Steps**:
1. Reduce production logging to error codes only
2. Use structured logger with log levels
3. Move detailed logging behind `DEV` flag

**Verification**:
```bash
cd packages/engine && pnpm test:run
cd landing && pnpm test:run
# Manual tests:
# - Auth flow works on localhost
# - Cookie domain correct for .grove.place
# - Rapid login attempts get rate limited
```

---

## Agent 4: Core Infrastructure Fixes

**Priority**: P1 (HIGH)
**Files**: 3 files, 3 issues
**Estimated Time**: 2 hours

### High Issues (3)

#### Issue 4.1: DatabaseErrorCode Type Mismatch
**File**: `/home/user/GroveEngine/packages/engine/src/lib/server/services/database.ts`
**Lines**: 732, 737, and type definition at 63-69
**Problem**: Using 'VALIDATION_ERROR' which isn't in the union type

**Fix Steps**:
1. Add 'VALIDATION_ERROR' to DatabaseErrorCode union at lines 63-69:
   ```typescript
   type DatabaseErrorCode =
     | 'QUERY_FAILED'
     | 'NOT_FOUND'
     | 'CONSTRAINT_VIOLATION'
     | 'TRANSACTION_FAILED'
     | 'CONNECTION_ERROR'
     | 'INVALID_QUERY'
     | 'VALIDATION_ERROR';  // Add this
   ```
2. Or change lines 732/737 to use 'INVALID_QUERY' if semantically appropriate

#### Issue 4.2: Any Type in Ref Property
**File**: `/home/user/GroveEngine/packages/engine/src/lib/utils.ts`
**Line**: 9
**Problem**: `ref?: any` bypasses type checking

**Fix Steps**:
1. Replace with proper typing:
   ```typescript
   type WithElementRef<T, E extends HTMLElement = HTMLElement> = T & {
     ref?: E | null;
   };
   ```
2. Update any usages that depend on the loose typing

#### Issue 4.3: Unvalidated API Response Assertions
**File**: `/home/user/GroveEngine/packages/engine/src/hooks.server.ts`
**Lines**: 231-240, 270-276
**Problem**: Type assertions without runtime validation

**Fix Steps**:
1. Add runtime validation before type assertion:
   ```typescript
   const data = await response.json();
   if (!data || typeof data.userId !== 'string') {
     throw new Error('Invalid API response');
   }
   const validatedData = data as ExpectedType;
   ```
2. Consider using zod for schema validation

**Verification**:
```bash
cd packages/engine
pnpm check  # TypeScript type checking
pnpm test:run
pnpm build
```

---

## Agent 5: Social & Federation Fixes

**Priority**: P1 (HIGH)
**Files**: 2 files, 2 issues
**Estimated Time**: 2 hours

### High Issues (2)

#### Issue 5.1: RSS Feed Hardcoded URL
**File**: `/home/user/GroveEngine/packages/engine/src/routes/api/feed/+server.ts`
**Line**: 15
**Problem**: Hardcoded "https://autumnsgrove.com" instead of tenant URL

**Fix Steps**:
1. Replace hardcoded URL with dynamic tenant URL:
   ```typescript
   const siteUrl = event.locals.context?.type === 'tenant'
     ? `https://${event.locals.context.tenant.subdomain}.grove.place`
     : 'https://grove.place';
   ```
2. Update all other hardcoded URLs in the feed

#### Issue 5.2: CSRF Allows Cross-Tenant Attacks
**File**: `/home/user/GroveEngine/packages/engine/src/lib/utils/csrf.js`
**Line**: 71
**Problem**: Any `*.grove.place` subdomain can make requests

**Fix Steps**:
1. Tighten validation to require same-origin OR explicit cross-tenant allowlist:
   ```javascript
   // Remove blanket .grove.place exception
   // Require exact host match for CSRF-protected endpoints
   const isSameOrigin = originUrl.hostname === hostUrl.hostname;
   if (!isSameOrigin && !isLocalhost) {
     return false;
   }
   ```
2. If cross-subdomain requests needed, implement explicit CORS + token verification

**Verification**:
```bash
cd packages/engine && pnpm test:run
# Manual tests:
# - RSS feed shows correct tenant URL
# - CSRF rejects requests from other subdomains
```

---

## ~~Agent 6: Analytics Privacy Fixes~~ ✅ MOSTLY FIXED

**Priority**: P0 (CRITICAL - PII exposure)
**Status**: ✅ Critical issues resolved, 1 low-priority item remaining

### Summary of Fixes

#### ~~Issue 6.1: PII Logged in Auth Callback~~ ✅ FIXED
**Solution**: `callback/+server.ts` line 320 now logs `userInfo.sub` (GroveAuth ID) instead of email. No PII is written to logs.

#### Issue 6.2: Logger Uses Console Directly - ⏳ DEFERRED (LOW PRIORITY)
**Status**: Not a PII exposure issue. Enhancement for production logging pipeline.
**Decision**: Acceptable for v1 launch. Can be addressed post-launch.

#### ~~Issue 6.3: Webhook Payloads Stored Without Cleanup~~ ❌ N/A
**Status**: Not applicable - Stripe backend has been removed. Payments are now handled externally via LemonSqueezy.

---

## Agent 7: UI Accessibility Fixes

**Priority**: P1 (HIGH)
**Files**: 6 files, 7 issues
**Estimated Time**: 3 hours

### Critical Issues (2)

#### Issue 7.1: SearchInput Missing Label
**File**: `/home/user/GroveEngine/packages/engine/src/lib/ui/components/forms/SearchInput.svelte`
**Lines**: 48-57
**Problem**: Textarea has no accessible label

**Fix Steps**:
1. Add aria-label to textarea:
   ```svelte
   <textarea
     aria-label="Search query"
     ...existing props
   />
   ```
2. Or add visible label with proper `for` attribute

#### Issue 7.2: MarkdownEditor Missing Label
**File**: `/home/user/GroveEngine/packages/engine/src/lib/components/admin/MarkdownEditor.svelte`
**Lines**: 579-592
**Problem**: Main textarea lacks accessible label

**Fix Steps**:
1. Add aria-label to textarea:
   ```svelte
   <textarea
     aria-label="Markdown editor content"
     ...existing props
   />
   ```

### High Issues (5)

#### Issue 7.3: Lightbox Keyboard Navigation
**File**: `/home/user/GroveEngine/packages/engine/src/lib/ui/components/gallery/Lightbox.svelte`
**Lines**: 27-50
**Problem**: Suppressed a11y warnings without proper keyboard handlers

**Fix Steps**:
1. Remove `svelte-ignore` comments
2. Verify keyboard handlers work correctly
3. Add focus trap for modal

#### Issue 7.4: ImageGallery A11y Suppression
**File**: `/home/user/GroveEngine/packages/engine/src/lib/ui/components/gallery/ImageGallery.svelte`
**Lines**: 163-172, 266-296
**Problem**: Multiple suppressed a11y warnings

**Fix Steps**:
1. Review each `svelte-ignore` and implement proper fix
2. Ensure keyboard navigation for all interactive elements

#### Issue 7.5: OnboardingChecklist Dismiss Button
**File**: `/home/user/GroveEngine/packages/engine/src/lib/components/OnboardingChecklist.svelte`
**Lines**: 32-38
**Problem**: Button has only title, missing aria-label

**Fix Steps**:
1. Add aria-label:
   ```svelte
   <button
     aria-label="Dismiss getting started checklist"
     title="Dismiss"
     ...
   />
   ```

#### Issue 7.6: ZoomableImage Role Misuse
**File**: `/home/user/GroveEngine/packages/engine/src/lib/ui/components/gallery/ZoomableImage.svelte`
**Lines**: 139-157
**Problem**: Image has `role="button"` which is incorrect

**Fix Steps**:
1. Wrap image in proper button:
   ```svelte
   <button
     onclick={handleClick}
     onkeydown={handleKeydown}
     aria-label="Click to zoom image"
     class="zoom-button"
   >
     <img {src} {alt} ... />
   </button>
   ```

#### Issue 7.7: Canvas A11y Suppression
**File**: `/home/user/GroveEngine/packages/engine/src/lib/ui/components/terrarium/Canvas.svelte`
**Lines**: 178-179
**Problem**: Interactive div suppresses a11y warnings

**Fix Steps**:
1. Use semantic `<canvas>` element
2. Add proper ARIA labels for assistive technology
3. Document keyboard controls if applicable

**Verification**:
```bash
cd packages/engine && pnpm build
# Run accessibility audit
npx axe-core packages/engine
# Manual screen reader testing
```

---

## ~~Agent 9: Build & CI Fixes~~ ✅ ALL FIXED

**Priority**: P1 (HIGH - enables testing)
**Status**: ✅ All 4 issues already resolved (verified January 2026)

### Summary of Fixes Already Implemented

#### ~~Issue 9.1: No Tests in CI Before Deploy~~ ✅ FIXED
**Solution**: `deploy-engine.yml` (and other deploy workflows) already includes:
- Lines 38-40: Type check (`pnpm check`)
- Lines 42-44: Run tests (`pnpm test:run`)
These run BEFORE the deploy step, ensuring broken code doesn't ship.

#### ~~Issue 9.2: Wrangler Version Inconsistency~~ ✅ FIXED
**Status**: Already resolved - both packages now use `^4.54.0`

#### ~~Issue 9.3: No .nvmrc File~~ ✅ FIXED
**Status**: Already resolved - `.nvmrc` exists with Node 20

#### ~~Issue 9.4: Vulnerable qs Dependency~~ ✅ FIXED
**Status**: Already resolved - `qs: >=6.14.1` override exists in root package.json

---

## Post-Fix Verification Checklist

After all agents complete, run this verification:

```bash
# 1. Full type check
pnpm -r check

# 2. Full test suite
pnpm -r test:run

# 3. Build all packages
pnpm -r build

# 4. Security audit
pnpm audit

# 5. Manual XSS testing
# - Create post with malicious content
# - Verify sanitization in SSR and client

# 6. Cross-tenant testing
# - Upload as tenant A
# - Try to access/delete as tenant B

# 7. Accessibility testing
npx axe-core packages/engine
```

---

## Summary

| Agent | Area | Critical | High | Est. Time | Status |
|-------|------|----------|------|-----------|--------|
| 1 | Content Security | 3 | 3 | 4h | ✅ **ALL FIXED** |
| 2 | Storage Security | 3 | 3 | 3h | ✅ **ALL FIXED** |
| 3 | Authentication | 0 | 4 | 3h | ⏳ Phase 2 |
| 4 | Core Infrastructure | 0 | 3 | 2h | ⏳ Phase 2 |
| 5 | Social & Federation | 0 | 2 | 2h | ⏳ Phase 2 |
| 6 | Analytics Privacy | 1 | 1 | 1.5h | ✅ **MOSTLY FIXED** (1 deferred) |
| 7 | UI Accessibility | 2 | 5 | 3h | ⏳ Phase 3 |
| 9 | Build & CI | 0 | 4 | 2h | ✅ **ALL FIXED** |
| **Total** | | **9** | **25** | **~20.5h** | |

*Note: Agent 8 (Durable Objects) has no issues - DOs are not yet implemented.*

### Phase 1 Completion (January 2026)

**All Critical (P0) issues are resolved!** ✅

#### Already Fixed (verified during audit):
- ✅ Agent 1: All 6 XSS/Content Security issues (SSR sanitization, blog posts, recursive markdown, DOMPurify race, gutter items, data attributes)
- ✅ Agent 2: All 6 Storage Security issues (tenant isolation in R2 paths, delete verification, list filtering, stream docs, file size limits, bounded scans)
- ✅ Agent 6: Issues 6.1 fixed (PII logging), 6.3 N/A (Stripe removed), 6.2 deferred (low priority)
- ✅ Agent 9: All 4 Build & CI issues (deploy tests, wrangler versions, .nvmrc, qs vulnerability)

### Remaining Work (Phase 2 & 3)
- **Phase 2**: Authentication (4), Core Infrastructure (3), Social & Federation (2) - ~7h
- **Phase 3**: UI Accessibility (7 issues) - ~3h
