# Pulse Curio — Architecture Plan

## Vision

Pulse is a **curio** — a per-tenant live development heartbeat that any Grove user can add to their site. Drop a webhook URL into your GitHub repo settings, and your blog gets a `/pulse` page showing your development rhythm in real time: commits flowing, PRs merging, issues moving, releases shipping.

Where **Timeline** narrates your daily work through AI-voiced summaries, and **Journey** tracks your repository's evolution through snapshots, **Pulse** shows the raw heartbeat — what's happening _right now_, no AI needed, no polling, just live webhooks.

**The setup is dead simple**: Enable Pulse in Arbor, copy the generated webhook URL + secret, paste into GitHub. Done. Events start flowing in seconds.

---

## Architecture Overview

```
GitHub Repo (user configures webhook)
    │
    ▼ POST https://grove-pulse.workers.dev/webhook/{tenant_id}
┌──────────────────────────────────┐
│  grove-pulse (Worker)            │
│  • Look up tenant's webhook_secret
│  • Verify X-Hub-Signature-256    │
│  • Normalize event payload       │
│  • Write to D1 (pulse_events)    │
│  • Update KV hot cache           │
│  • Cron: hourly/daily rollups    │
└──────────────────────────────────┘
    │           │
    ▼           ▼
  ┌───┐     ┌────┐
  │D1 │     │ KV │  (shared grove-engine-db + CACHE_KV)
  └───┘     └────┘
    │           │
    ▼           ▼
┌──────────────────────────────────┐
│  grove-engine (tenant site)      │
│  /{tenant}.grove.place/pulse     │
│  • API: /api/curios/pulse/*      │
│  • Arbor: /arbor/curios/pulse    │
│  • Public: /pulse page           │
└──────────────────────────────────┘
```

### Key Difference from Timeline/Journey

Timeline and Journey use **polling** (cron workers calling GitHub API with stored tokens). Pulse uses **push** (GitHub sends events to us via webhooks). This means:

- **No GitHub token needed** — webhooks are configured on GitHub's side, not ours
- **No API rate limits** — events come to us, we don't fetch them
- **Truly real-time** — events arrive within seconds of the action
- **Simpler config** — just enable + copy a URL, no secrets to encrypt
- **Works with any repo** — public or private, the webhook fires regardless

---

## Component 1: Curio Registration

**File:** `libs/engine/src/lib/curios/registry.ts`

```typescript
const pulse: CurioDefinition = {
  id: "pulse",
  name: "Pulse",
  description:
    "Live development heartbeat — real-time activity from your GitHub repos",
  category: "integration",
  minTier: "seedling", // Available to all tiers
  placements: ["dedicated", "left-vine", "right-vine"],
  defaultPlacement: "dedicated",
  hasAdminPanel: true,
  hasDedicatedPage: true,
  icon: "activity", // Lucide "activity" (heartbeat line)
};
```

---

## Component 2: D1 Schema

**Migration:** `libs/engine/migrations/XXX_pulse_curio.sql`

Following the engine migration chain (like Timeline 024, Journey 025). Next available number.

### Table: `pulse_config` — Per-tenant settings

```sql
CREATE TABLE IF NOT EXISTS pulse_config (
    tenant_id TEXT PRIMARY KEY,
    enabled INTEGER DEFAULT 0,
    webhook_secret TEXT NOT NULL,      -- HMAC secret (generated on enable)
    -- Display preferences
    show_heatmap INTEGER DEFAULT 1,
    show_feed INTEGER DEFAULT 1,
    show_stats INTEGER DEFAULT 1,
    show_trends INTEGER DEFAULT 1,
    show_ci INTEGER DEFAULT 1,
    -- Filtering
    repos_include TEXT,                -- JSON array: only these repos (null = all)
    repos_exclude TEXT,                -- JSON array: ignore these repos
    -- Settings
    timezone TEXT DEFAULT 'America/New_York',
    feed_max_items INTEGER DEFAULT 100,
    created_at INTEGER DEFAULT (strftime('%s', 'now')),
    updated_at INTEGER DEFAULT (strftime('%s', 'now')),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
);
```

**Note on `webhook_secret`**: Unlike Timeline/Journey tokens (which are user-provided API keys that need encryption), the webhook secret is _generated by us_ and only needs to be shown once to the user during setup. It's stored plaintext because:

1. It's not a credential for an external service — it's a shared HMAC key we generated
2. The worker needs to read it on every request for verification (no decryption overhead)
3. If the DB is compromised, the attacker can only _send_ fake webhook events, not access GitHub

If we want to be extra cautious, we can encrypt it with envelope encryption like Timeline tokens. Decision: **encrypt it** — follows the principle of least surprise and matches existing curio patterns.

### Table: `pulse_events` — Normalized webhook events

```sql
CREATE TABLE IF NOT EXISTS pulse_events (
    id TEXT PRIMARY KEY,
    tenant_id TEXT NOT NULL,
    delivery_id TEXT,                  -- GitHub X-GitHub-Delivery (idempotency)
    event_type TEXT NOT NULL,          -- push, pull_request, issues, release, etc.
    action TEXT,                       -- opened, closed, merged, created, etc.
    repo_name TEXT NOT NULL,           -- Short name (e.g., "Lattice")
    repo_full_name TEXT NOT NULL,      -- Full name (e.g., "AutumnsGrove/Lattice")
    actor TEXT NOT NULL,               -- GitHub username
    title TEXT,                        -- Commit message / PR title / issue title
    ref TEXT,                          -- Branch name or tag
    data TEXT,                         -- JSON: event-specific normalized details
    occurred_at INTEGER NOT NULL,      -- Event timestamp (unix seconds)
    created_at INTEGER DEFAULT (strftime('%s', 'now')),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
);

CREATE UNIQUE INDEX idx_pulse_events_delivery
    ON pulse_events(tenant_id, delivery_id);
CREATE INDEX idx_pulse_events_tenant_time
    ON pulse_events(tenant_id, occurred_at DESC);
CREATE INDEX idx_pulse_events_tenant_type
    ON pulse_events(tenant_id, event_type, occurred_at DESC);
CREATE INDEX idx_pulse_events_tenant_repo
    ON pulse_events(tenant_id, repo_name, occurred_at DESC);
```

**`data` JSON varies by event type:**

| Event          | `data` shape                                                                                    |
| -------------- | ----------------------------------------------------------------------------------------------- |
| `push`         | `{ commits: number, additions: number, deletions: number, files_changed: number, sha: string }` |
| `pull_request` | `{ number: number, draft: boolean, labels: string[], merged: boolean, merge_hours: number? }`   |
| `issues`       | `{ number: number, labels: string[] }`                                                          |
| `release`      | `{ tag: string, prerelease: boolean, name: string }`                                            |
| `workflow_run` | `{ name: string, conclusion: string, branch: string }`                                          |
| `star`         | `{ total: number }`                                                                             |
| `fork`         | `{ total: number, forker: string }`                                                             |
| `create`       | `{ ref_type: string }`                                                                          |
| `delete`       | `{ ref_type: string }`                                                                          |

### Table: `pulse_daily_stats` — Aggregated daily metrics

```sql
CREATE TABLE IF NOT EXISTS pulse_daily_stats (
    id TEXT PRIMARY KEY,
    tenant_id TEXT NOT NULL,
    date TEXT NOT NULL,                -- YYYY-MM-DD
    repo_name TEXT,                    -- NULL = all repos combined
    commits INTEGER DEFAULT 0,
    lines_added INTEGER DEFAULT 0,
    lines_removed INTEGER DEFAULT 0,
    files_changed INTEGER DEFAULT 0,
    prs_opened INTEGER DEFAULT 0,
    prs_merged INTEGER DEFAULT 0,
    prs_closed INTEGER DEFAULT 0,
    issues_opened INTEGER DEFAULT 0,
    issues_closed INTEGER DEFAULT 0,
    releases INTEGER DEFAULT 0,
    ci_passes INTEGER DEFAULT 0,
    ci_failures INTEGER DEFAULT 0,
    stars_total INTEGER,
    forks_total INTEGER,
    created_at INTEGER DEFAULT (strftime('%s', 'now')),
    updated_at INTEGER DEFAULT (strftime('%s', 'now')),
    UNIQUE(tenant_id, date, repo_name),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
);

CREATE INDEX idx_pulse_daily_tenant_date
    ON pulse_daily_stats(tenant_id, date DESC);
```

### Table: `pulse_hourly_activity` — Heatmap data

```sql
CREATE TABLE IF NOT EXISTS pulse_hourly_activity (
    id TEXT PRIMARY KEY,
    tenant_id TEXT NOT NULL,
    date TEXT NOT NULL,                -- YYYY-MM-DD
    hour INTEGER NOT NULL,            -- 0-23 (UTC)
    commits INTEGER DEFAULT 0,
    events INTEGER DEFAULT 0,
    created_at INTEGER DEFAULT (strftime('%s', 'now')),
    UNIQUE(tenant_id, date, hour),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
);

CREATE INDEX idx_pulse_hourly_tenant_date
    ON pulse_hourly_activity(tenant_id, date DESC);
```

### Retention

- `pulse_events`: **90 days** (add to existing webhook-cleanup worker cron)
- `pulse_daily_stats`: **Indefinite** (small rows, valuable for long-term trends)
- `pulse_hourly_activity`: **90 days** (add to cleanup)

---

## Component 3: Webhook Receiver Worker

**Location:** `workers/pulse/`

A dedicated Cloudflare Worker. Same pattern as `workers/email-catchup/` and `workers/timeline-sync/`.

### Why a Dedicated Worker

- **Cron triggers** for aggregation (Pages can't do cron)
- **Isolation** from the engine — webhook processing shouldn't affect tenant sites
- **No SvelteKit overhead** — raw Worker for maximum speed on hot path
- **Independent scaling** — webhook volume is unpredictable

### Routing: Per-Tenant Webhook URLs

Each tenant gets a unique URL:

```
POST https://grove-pulse.workers.dev/webhook/{tenant_id}
```

The worker:

1. Extracts `tenant_id` from the URL path
2. Looks up `pulse_config` for that tenant (confirms `enabled = 1`)
3. Decrypts `webhook_secret` for that tenant
4. Verifies `X-Hub-Signature-256` using that tenant's secret
5. Processes the event

**Why tenant_id in URL (not just secret matching)?**

- O(1) lookup instead of scanning all tenants
- Tenant isolation — one tenant's events can't collide with another's
- The URL isn't sensitive — the HMAC secret provides authentication
- GitHub webhook settings show the URL clearly, making debugging easy

### Worker Structure

```
workers/pulse/
├── src/
│   ├── index.ts              # fetch() + scheduled()
│   ├── types.ts              # Env, event types
│   ├── verify.ts             # HMAC-SHA256 verification
│   ├── normalize.ts          # Event payload normalization (all handlers)
│   ├── store.ts              # D1 writes + KV updates
│   └── aggregate.ts          # Cron: hourly/daily stat rollups
├── wrangler.toml
├── package.json
└── tsconfig.json
```

**Design choice**: One `normalize.ts` file with a switch statement instead of separate handler files. Webhook normalization is lightweight — each handler is 10-20 lines of field extraction. Separate files would be over-engineering for what amounts to a mapping function.

### Wrangler Config

```toml
name = "grove-pulse"
main = "src/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

[triggers]
crons = [
  "0 * * * *",    # Hourly: rollup hourly_activity from events
  "5 0 * * *",    # Daily at 00:05 UTC: finalize daily_stats
]

[[d1_databases]]
binding = "DB"
database_name = "grove-engine-db"
database_id = "a6394da2-b7a6-48ce-b7fe-b1eb3e730e68"

[[kv_namespaces]]
binding = "KV"
id = "514e91e81cc44d128a82ec6f668303e4"  # Shared CACHE_KV

[vars]
GROVE_KEK = ""  # Set via wrangler secret — for envelope encryption
```

### Webhook Events to Handle

| Event          | Action(s)                      | What We Normalize & Store                              |
| -------------- | ------------------------------ | ------------------------------------------------------ |
| `push`         | —                              | Commit count, head commit message, additions/deletions |
| `pull_request` | opened/closed/merged/reopened  | Title, state, draft, labels, merge time calculation    |
| `issues`       | opened/closed/reopened/labeled | Title, state, labels                                   |
| `release`      | published                      | Tag name, release name, prerelease flag                |
| `create`       | —                              | ref_type (branch/tag), ref name                        |
| `delete`       | —                              | ref_type (branch/tag), ref name                        |
| `workflow_run` | completed                      | Workflow name, conclusion (success/failure), branch    |
| `star`         | created/deleted                | New total count                                        |
| `fork`         | created                        | New total count, forker username                       |

### Signature Verification

```typescript
async function verifySignature(
  payload: string,
  signature: string | null,
  secret: string,
): Promise<boolean> {
  if (!signature?.startsWith("sha256=")) return false;
  const key = await crypto.subtle.importKey(
    "raw",
    new TextEncoder().encode(secret),
    { name: "HMAC", hash: "SHA-256" },
    false,
    ["sign"],
  );
  const sig = await crypto.subtle.sign(
    "HMAC",
    key,
    new TextEncoder().encode(payload),
  );
  const expected =
    "sha256=" +
    Array.from(new Uint8Array(sig))
      .map((b) => b.toString(16).padStart(2, "0"))
      .join("");
  return signature === expected;
}
```

Uses Web Crypto API (available in Workers), not Node crypto.

### Repo Filtering

If `repos_include` is set in config, only process events from those repos. If `repos_exclude` is set, skip events from those repos. If neither is set, accept all. Checked after signature verification, before D1 write.

---

## Component 4: KV Hot Cache

Keys prefixed with `pulse:{tenant_id}:` for multi-tenant isolation.

| Key                         | Value                                                      | TTL   | Updated                 |
| --------------------------- | ---------------------------------------------------------- | ----- | ----------------------- |
| `pulse:{tid}:latest:commit` | `{ repo, message, author, sha, time }`                     | 24h   | Every push              |
| `pulse:{tid}:latest:event`  | `{ type, action, repo, title, time }`                      | 24h   | Every event             |
| `pulse:{tid}:today`         | `{ commits, prs_merged, issues_closed, lines_added, ... }` | 2h    | Every event (increment) |
| `pulse:{tid}:active`        | `{ active: true, last_commit: timestamp, author }`         | 30min | Every push              |
| `pulse:{tid}:streak`        | `{ days: number, since: date }`                            | 24h   | Daily cron              |

### Why KV + D1

- KV reads are ~1ms at the edge; D1 queries take 100-300ms
- The "currently active" pulsing indicator needs sub-second response
- Today's stats increment on every event — KV write is cheaper than D1 UPDATE
- D1 serves historical queries (charts, feed, trends); KV serves "right now"

### KV Update Strategy for `pulse:{tid}:today`

On each event, the worker:

1. Reads current `pulse:{tid}:today` from KV
2. Increments the relevant counter
3. Writes back with 2h TTL

If the KV key has expired (stale), recompute from D1 `pulse_events` for today. This is an eventual-consistency tradeoff — the counters might be slightly off if two webhooks arrive simultaneously, but for a dashboard this is perfectly acceptable.

---

## Component 5: Engine Library Module

**Location:** `libs/engine/src/lib/curios/pulse/`

### Types & Defaults

```typescript
// libs/engine/src/lib/curios/pulse/index.ts

export interface PulseConfig {
  tenantId: string;
  enabled: boolean;
  webhookSecret: string;       // Generated, encrypted at rest
  showHeatmap: boolean;
  showFeed: boolean;
  showStats: boolean;
  showTrends: boolean;
  showCi: boolean;
  reposInclude: string[] | null;
  reposExclude: string[] | null;
  timezone: string;
  feedMaxItems: number;
}

export interface PulseEvent {
  id: string;
  tenantId: string;
  deliveryId: string;
  eventType: string;
  action: string | null;
  repoName: string;
  repoFullName: string;
  actor: string;
  title: string | null;
  ref: string | null;
  data: Record<string, unknown>;
  occurredAt: number;
}

export interface PulseDailyStats { ... }
export interface PulseHourlyActivity { ... }

export interface PulsePageData {
  config: PulseConfig;
  active: { isActive: boolean; lastCommit?: number; author?: string };
  today: { commits: number; prsMerged: number; issuesClosed: number; linesAdded: number; linesRemoved: number };
  streak: { days: number; since: string };
  events: PulseEvent[];
  dailyStats: PulseDailyStats[];
  hourlyActivity: PulseHourlyActivity[];
}

export const PULSE_DEFAULTS = {
  showHeatmap: true,
  showFeed: true,
  showStats: true,
  showTrends: true,
  showCi: true,
  timezone: 'America/New_York',
  feedMaxItems: 100,
} as const;
```

---

## Component 6: API Endpoints

**Location:** `libs/engine/src/routes/api/curios/pulse/`

Following the exact pattern of Timeline and Journey.

### GET /api/curios/pulse/config

Returns config for the current tenant. Secrets are returned as boolean flags (`hasWebhookSecret`), not raw values. Also returns the generated webhook URL.

### PUT /api/curios/pulse/config

Updates config. On first enable:

1. Generate a random webhook secret (32 bytes, hex)
2. Encrypt and store it
3. Return the webhook URL + plaintext secret (shown once)

On subsequent updates: only update display prefs, repo filters, etc. Secret can be regenerated explicitly.

### POST /api/curios/pulse/config/regenerate-secret

Generates a new webhook secret. Returns the new plaintext secret (shown once). Invalidates the old one. User must update GitHub webhook settings.

### GET /api/curios/pulse

Public data endpoint. Returns events + stats for display.

```typescript
GET /api/curios/pulse?limit=50&offset=0&type=push,pull_request&since=2026-02-01

Response: {
  events: PulseEvent[],
  pagination: { total, limit, offset, hasMore },
  today: { commits, prsMerged, ... },
  active: { isActive, lastCommit, author },
  streak: { days, since }
}
```

- Checks `enabled` gate first (404 if disabled)
- KV for hot data (today, active, streak)
- D1 for events with pagination
- Supports type filtering and date range
- Cache-Control: `public, max-age=60, stale-while-revalidate=300`

### GET /api/curios/pulse/stats

Returns aggregated stats for charts.

```typescript
GET /api/curios/pulse/stats?days=30

Response: {
  daily: PulseDailyStats[],     // Last N days
  hourly: PulseHourlyActivity[] // Last 7 days
}
```

---

## Component 7: Arbor Admin UI

**Location:** `libs/engine/src/routes/arbor/curios/pulse/`

### Sections

#### 1. Enable & Webhook Setup

- Toggle: Enable/disable Pulse
- **Webhook URL** (read-only, copyable): `https://grove-pulse.workers.dev/webhook/{tenant_id}`
- **Webhook Secret** (shown once on generate, then hidden): Copy button
- "Regenerate Secret" button (with confirmation)
- **Setup instructions**: Step-by-step for adding to GitHub (with screenshots/links)
  1. Go to your repo Settings > Webhooks > Add webhook
  2. Paste this URL
  3. Set content type to `application/json`
  4. Paste this secret
  5. Select events: Pushes, Pull requests, Issues, Releases, Workflow runs, Stars, Forks
  6. Save

#### 2. Repository Filtering

- Include list: Only track these repos (text input, comma-separated)
- Exclude list: Ignore these repos
- "Leave both empty to track all repos"

#### 3. Display Options

- Toggle: Show activity heatmap
- Toggle: Show event feed
- Toggle: Show stats cards
- Toggle: Show trend charts
- Toggle: Show CI health
- Timezone selector

#### 4. Status & Health

- Last event received: timestamp + event type
- Events received today: count
- Webhook health: green/yellow/red based on recent activity
- "Test Webhook" button that sends a ping event

---

## Component 8: Public Page & Components

### Svelte Components (Engine)

**Location:** `libs/engine/src/lib/curios/pulse/`

| Component               | Purpose                                    |
| ----------------------- | ------------------------------------------ |
| `Pulse.svelte`          | Full dedicated page layout                 |
| `PulseCompact.svelte`   | Vine-sized widget (stats + last event)     |
| `PulseIndicator.svelte` | Pulsing dot (active/inactive)              |
| `PulseStats.svelte`     | Today's stats cards row                    |
| `PulseHeatmap.svelte`   | 7-day x 24-hour activity grid              |
| `PulseFeed.svelte`      | Chronological event feed with type filters |
| `PulseTrends.svelte`    | 30-day trend sparklines/charts             |

Following the engine-first pattern — components live in the engine, imported by the site route.

### Page Route (Tenant Site)

**Location:** `libs/engine/src/routes/(site)/pulse/`

```typescript
// +page.server.ts
export const load: PageServerLoad = async ({ platform, locals }) => {
  const db = platform?.env?.DB;
  const kv = platform?.env?.CACHE_KV;

  // Check enabled
  const config = await db
    .prepare("SELECT * FROM pulse_config WHERE tenant_id = ? AND enabled = 1")
    .bind(locals.tenantId)
    .first();
  if (!config) error(404, "Pulse is not enabled");

  // Parallel: KV hot data + D1 historical
  const [active, today, streak, events, dailyStats, hourlyActivity] =
    await Promise.all([
      kv.get(`pulse:${locals.tenantId}:active`, "json"),
      kv.get(`pulse:${locals.tenantId}:today`, "json"),
      kv.get(`pulse:${locals.tenantId}:streak`, "json"),
      loadRecentEvents(db, locals.tenantId, 50),
      loadDailyStats(db, locals.tenantId, 30),
      loadHourlyActivity(db, locals.tenantId, 7),
    ]);

  return { config, active, today, streak, events, dailyStats, hourlyActivity };
};
```

### Page Sections

#### 1. Hero — Heartbeat

- Pulsing `PulseIndicator` (green dot with ripple animation when active)
- "Currently building..." with last commit message when `active.isActive`
- "Last seen X hours ago" when inactive
- Streak badge when > 1 day

#### 2. Today's Stats

- 4 glassmorphism cards: Commits, PRs Merged, Issues Closed, Lines Changed
- Each with a mini sparkline (hourly distribution)
- Reuses existing `Sparkline` from engine charts

#### 3. Activity Heatmap

- 7 rows (days) x 24 columns (hours)
- Seasonal color intensity (spring greens, summer golds, autumn ambers, winter blues)
- Tooltip on hover: "Tuesday 3pm: 8 commits"
- Timezone-aware display (UTC data -> visitor's local time via client JS)

#### 4. Event Feed

- Chronological list, newest first
- Event type icons with color coding:
  - Push — grove green
  - PR merged — purple
  - PR opened — blue
  - Issue opened — amber
  - Issue closed — muted
  - CI failed — warm red
  - Release — gold
- Filter chips (toggle by event type)
- "Show more" pagination
- Relative timestamps

#### 5. Trends (30-day)

- Commit velocity line
- Code churn (additions/deletions)
- Issue burn-down
- "This week vs last week" deltas

#### 6. CI & Releases

- Latest CI badge
- Pass rate
- Recent releases list

### UI Design

All components follow Grove design system:

- **Glassmorphism** via `GlassCard` wrappers
- **Seasonal** colors from `seasonStore`
- **Dark mode**: "nature at night" warmth
- **Responsive**: Mobile-first (1-col -> 2-col -> 4-col)
- **Reduced motion**: All pulse animations respect `prefers-reduced-motion`
- **Accessible**: WCAG AA, ARIA labels on heatmap cells, semantic event feed

---

## Component 9: grove.place/pulse (Landing Page)

The curio lives on tenant sites (`{user}.grove.place/pulse`), but `grove.place/pulse` serves as a **showcase page** on the marketing site:

- Shows Autumn's own Pulse data (Autumn's tenant is the dogfood)
- Explains the feature: "Add a live heartbeat to your Grove site"
- Setup instructions
- CTA: "Enable Pulse in your dashboard"

This is a simple landing route, not a curio route — it reads from Autumn's tenant data via D1 directly.

---

## Implementation Phases

### Phase 1: Foundation

1. Register Pulse in curio registry
2. Write D1 migration (pulse_config, pulse_events, pulse_daily_stats, pulse_hourly_activity)
3. Create `workers/pulse/` webhook receiver worker
4. Implement HMAC signature verification with per-tenant secrets
5. Handle `push` and `pull_request` events (most common, highest value)
6. KV hot cache: latest commit, today's stats, active indicator
7. API endpoints: config GET/PUT, events GET
8. Arbor admin page: enable toggle, webhook URL display, secret generation
9. Basic `/pulse` page on tenant site: hero + stats + feed

### Phase 2: All Events + Heatmap

1. Handle remaining events: issues, release, workflow_run, star, fork, create, delete
2. Cron aggregation: hourly activity rollups, daily stats finalization
3. `PulseHeatmap` component
4. `PulseTrends` component with sparklines
5. Event type filtering in feed
6. Repo filtering support in config + worker

### Phase 3: Polish

1. Streak tracking (daily cron)
2. CI health section
3. Vine-sized `PulseCompact` widget
4. Seasonal heatmap colors
5. SEO + OG image
6. 90-day cleanup rules (add to webhook-cleanup worker)
7. `grove.place/pulse` showcase page
8. Waystone help markers in Arbor

### Phase 4: Future

- Timeline integration: "this commit triggered this AI summary"
- Journey integration: "this release created a new snapshot"
- WebSocket/SSE for true real-time feed updates
- Daily digest: AI-summarized "pulse report" (reuse Timeline's OpenRouter integration)
- Multi-org support (multiple GitHub orgs/users)
- Contributor leaderboard
- "First commit of the day" badge

---

## Files to Create

### Worker

| File                             | Purpose                               |
| -------------------------------- | ------------------------------------- |
| `workers/pulse/src/index.ts`     | Worker entry: fetch() + scheduled()   |
| `workers/pulse/src/types.ts`     | Env interface, event types            |
| `workers/pulse/src/verify.ts`    | HMAC-SHA256 signature verification    |
| `workers/pulse/src/normalize.ts` | Event normalization (all event types) |
| `workers/pulse/src/store.ts`     | D1 writes + KV cache updates          |
| `workers/pulse/src/aggregate.ts` | Cron: hourly/daily rollups            |
| `workers/pulse/wrangler.toml`    | Worker config with cron triggers      |
| `workers/pulse/package.json`     | Package config                        |
| `workers/pulse/tsconfig.json`    | TypeScript config                     |

### Engine (Curio Module)

| File                                                         | Purpose                         |
| ------------------------------------------------------------ | ------------------------------- |
| `libs/engine/src/lib/curios/pulse/index.ts`              | Types, defaults, config helpers |
| `libs/engine/src/lib/curios/pulse/Pulse.svelte`          | Full page component             |
| `libs/engine/src/lib/curios/pulse/PulseCompact.svelte`   | Vine widget                     |
| `libs/engine/src/lib/curios/pulse/PulseIndicator.svelte` | Active/inactive dot             |
| `libs/engine/src/lib/curios/pulse/PulseStats.svelte`     | Stats card row                  |
| `libs/engine/src/lib/curios/pulse/PulseHeatmap.svelte`   | Activity heatmap                |
| `libs/engine/src/lib/curios/pulse/PulseFeed.svelte`      | Event feed                      |
| `libs/engine/src/lib/curios/pulse/PulseTrends.svelte`    | Trend charts                    |

### Engine (Routes)

| File                                                            | Purpose              |
| --------------------------------------------------------------- | -------------------- |
| `libs/engine/src/routes/api/curios/pulse/+server.ts`        | Public events API    |
| `libs/engine/src/routes/api/curios/pulse/config/+server.ts` | Config GET/PUT       |
| `libs/engine/src/routes/api/curios/pulse/stats/+server.ts`  | Aggregated stats API |
| `libs/engine/src/routes/(site)/pulse/+page.server.ts`       | Page data loader     |
| `libs/engine/src/routes/(site)/pulse/+page.svelte`          | Public page          |
| `libs/engine/src/routes/arbor/curios/pulse/+page.svelte`    | Admin config UI      |
| `libs/engine/src/routes/arbor/curios/pulse/+page.server.ts` | Admin data loader    |

### Migration

| File                                             | Purpose                |
| ------------------------------------------------ | ---------------------- |
| `libs/engine/migrations/XXX_pulse_curio.sql` | All 4 tables + indexes |

## Files to Modify

| File                                                   | Change                              |
| ------------------------------------------------------ | ----------------------------------- |
| `libs/engine/src/lib/curios/registry.ts`           | Register pulse curio                |
| `libs/engine/src/routes/arbor/curios/+page.svelte` | Add Pulse card to hub               |
| `workers/webhook-cleanup/src/index.ts`        | Add 90-day cleanup for pulse tables |
| `pnpm-workspace.yaml`                                  | Add `workers/pulse`                 |

---

## Key Design Decisions

### Why Webhooks (Not API Polling Like Timeline)

- **Real-time**: Events arrive in seconds, not on a cron schedule
- **No token needed**: User doesn't share GitHub credentials with us
- **No rate limits**: GitHub pushes to us; we don't hit their API
- **Simpler setup**: Copy URL + secret, done
- **Works everywhere**: Public repos, private repos, org repos, personal repos

### Why Per-Tenant Webhook URLs

- O(1) tenant lookup (not scanning all secrets)
- Clear isolation between tenants
- Easy debugging (the URL tells you which tenant)
- Tenant ID isn't sensitive — the HMAC secret provides auth

### Why Encrypt the Webhook Secret

- Follows principle of least privilege (even though it's our generated key)
- Matches existing curio patterns (Timeline/Journey encrypt tokens)
- Envelope encryption via SecretsManager + GROVE_KEK is already built

### Why a Curio (Not a Landing-Only Feature)

- **Any user can have it** — not just grove.place
- **Multi-tenant by design** — each user's Pulse is isolated
- **Fits the ecosystem** — Timeline narrates, Journey tracks, Pulse beats
- **Vine placement** — can appear as a compact widget in sidebars
- **Admin UI** — managed through Arbor like every other curio
- **Tier gating** — seedling tier means everyone gets it (great for adoption)

### Why Raw Events + Aggregation (Not Just Aggregation)

- Raw events power the chronological feed
- Future: search, filter, export
- Aggregation happens in cron, not on the hot webhook path
- 90-day retention keeps storage bounded

---

## The User Experience

### Setup (30 seconds)

1. Open Arbor > Curios > Pulse
2. Toggle "Enable"
3. Copy the webhook URL and secret
4. Go to GitHub repo > Settings > Webhooks > Add
5. Paste URL, set JSON content type, paste secret
6. Select events (or "Send me everything")
7. Save

### What They See

Their `/pulse` page lights up within seconds of the first push:

> A gentle green dot pulses steadily.
>
> "Currently building... _fix: resolve auth redirect on mobile_"
>
> **Today**: 12 commits | 2 PRs merged | 3 issues closed | +847/-203 lines
>
> A warm heatmap shows the rhythm of their day — morning burst, quiet lunch, afternoon flow.
>
> Below, a feed scrolls: each commit, each PR, each issue, each release — the living story of their work, told in real time, on _their_ site, in _their_ space.

That's Pulse. The heartbeat of someone building something they care about.
