# Grove Durable Objects Worker
# Hosts all Durable Objects for the Grove Platform
#
# This worker exports DO classes that are referenced by:
# - GroveEngine (Pages) via service binding
# - Post-Migrator worker
#
# Deploy: pnpm deploy (from this directory)

name = "grove-durable-objects"
main = "src/index.ts"
compatibility_date = "2025-01-01"

# =============================================================================
# Durable Objects - Loom Pattern (Grove's coordination layer)
# =============================================================================

# TenantDO: Per-tenant config caching, draft sync, analytics buffering
[[durable_objects.bindings]]
name = "TENANTS"
class_name = "TenantDO"

# PostMetaDO: Per-post reactions, views, real-time presence (hot data)
[[durable_objects.bindings]]
name = "POST_META"
class_name = "PostMetaDO"

# PostContentDO: Per-post content caching (warm data, hibernates quickly)
[[durable_objects.bindings]]
name = "POST_CONTENT"
class_name = "PostContentDO"

# SentinelDO: Stress test coordination (long-running tests, WebSocket updates)
[[durable_objects.bindings]]
name = "SENTINEL"
class_name = "SentinelDO"

# ExportDO: Per-export zip assembly job (alarm-based, long-running)
[[durable_objects.bindings]]
name = "EXPORTS"
class_name = "ExportDO"

# TriageDO: Email triage processing + digest scheduling (alarm-based)
[[durable_objects.bindings]]
name = "TRIAGE"
class_name = "TriageDO"

# ThresholdDO: Per-identifier rate limiting (Loom pattern)
[[durable_objects.bindings]]
name = "THRESHOLD"
class_name = "ThresholdDO"

# =============================================================================
# DO Migrations - Declare new SQLite-backed classes
# =============================================================================
[[migrations]]
tag = "v1"
new_sqlite_classes = ["TenantDO"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["PostMetaDO", "PostContentDO"]

[[migrations]]
tag = "v3"
new_sqlite_classes = ["SentinelDO"]

[[migrations]]
tag = "v4"
new_sqlite_classes = ["ExportDO"]

[[migrations]]
tag = "v5"
new_sqlite_classes = ["TriageDO"]

[[migrations]]
tag = "v6"
new_sqlite_classes = ["ThresholdDO"]

# =============================================================================
# Zephyr Service Binding (email gateway â€” for ExportDO email delivery)
# =============================================================================
[[services]]
binding = "ZEPHYR"
service = "grove-zephyr"

# =============================================================================
# Ivy D1 Database - For TriageDO email queries
# =============================================================================
[[d1_databases]]
binding = "IVY_DB"
database_name = "ivy-db"
database_id = "57738720-bc43-4a7f-ad5b-ceb86b3c0542"

# =============================================================================
# Ivy R2 Bucket - For TriageDO email body storage
# =============================================================================
[[r2_buckets]]
binding = "IVY_R2"
bucket_name = "ivy-storage"

# =============================================================================
# Workers AI - For Lumen classification in TriageDO
# =============================================================================
[ai]
binding = "AI"

# =============================================================================
# KV Namespace - For caching and rate limiting (used by SentinelDO)
# =============================================================================
[[kv_namespaces]]
binding = "KV"
id = "514e91e81cc44d128a82ec6f668303e4"

# =============================================================================
# D1 Database - For DO fallback queries
# =============================================================================
[[d1_databases]]
binding = "DB"
database_name = "grove-engine-db"
database_id = "a6394da2-b7a6-48ce-b7fe-b1eb3e730e68"

# =============================================================================
# R2 Bucket - For reading user-uploaded images (included in export zips)
# =============================================================================
[[r2_buckets]]
binding = "IMAGES"
bucket_name = "grove-media"

# =============================================================================
# R2 Bucket - Dedicated bucket for temporary export zip files
# =============================================================================
[[r2_buckets]]
binding = "EXPORTS_BUCKET"
bucket_name = "grove-exports"
