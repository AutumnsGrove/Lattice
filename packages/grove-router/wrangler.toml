# Grove Router Worker
# Proxies wildcard subdomain requests to groveengine Pages
#
# This worker catches all *.grove.place requests and forwards them
# to grove-lattice.pages.dev with the original host in X-Forwarded-Host.

name = "grove-router"
main = "src/index.ts"
compatibility_date = "2025-01-01"

# Route configuration - catch all wildcard subdomains
# More specific routes (auth.grove.place, etc.) should be configured
# in Cloudflare Dashboard HTTP Routes to take precedence
routes = [
  { pattern = "*.grove.place/*", zone_name = "grove.place" }
]

# R2 bindings for CDN
# grove-cdn: static assets, fonts, admin-uploaded files
[[r2_buckets]]
binding = "CDN"
bucket_name = "grove-cdn"

# grove-media: user-uploaded images (tenant-prefixed paths)
[[r2_buckets]]
binding = "MEDIA"
bucket_name = "grove-media"

# =============================================================================
# Service Bindings - Direct Worker-to-Worker communication
# =============================================================================
# These replace public URL fetches with internal Cloudflare networking,
# eliminating DNS resolution, TLS overhead, and Error 1042 failures.

[[services]]
binding = "SCOUT"
service = "scout"

[[services]]
binding = "AUTH_API"
service = "groveauth"

[[services]]
binding = "MC_CONTROL"
service = "mc-control"

[[services]]
binding = "MYCELIUM"
service = "mycelium"

[[services]]
binding = "OG"
service = "grove-og"

# Cron triggers
# - Every minute: keepalive to prevent cold starts (~10s delay on first request)
[triggers]
crons = ["* * * * *"]
