# GroveEngine - Cloudflare Pages Configuration
# Each Grove site runs as its own Cloudflare Pages deployment
#
# SETUP INSTRUCTIONS:
# 1. Replace "your-site-name" with your actual site name
# 2. Create D1 database: npx wrangler d1 create your-site-posts
# 3. Create R2 bucket: npx wrangler r2 bucket create your-site-images
# 4. Create KV namespace: npx wrangler kv:namespace create CACHE
# 5. Update the IDs below with actual values from creation output
# 6. Set secrets: npx wrangler secret put SESSION_SECRET (etc.)

name = "grove-lattice"
compatibility_date = "2025-01-01"
# nodejs_compat_v2 is enabled in Cloudflare Pages dashboard

# Cloudflare Pages Functions output directory
pages_build_output_dir = ".svelte-kit/cloudflare"

# =============================================================================
# KV Namespace - For caching and rate limiting
# =============================================================================
[[kv_namespaces]]
binding = "CACHE_KV"
id = "514e91e81cc44d128a82ec6f668303e4"

# =============================================================================
# KV Namespace - For feature flags caching
# =============================================================================
# Create with: npx wrangler kv:namespace create FLAGS_KV
# Then update the ID below with the actual value from the creation output
[[kv_namespaces]]
binding = "FLAGS_KV"
id = "65a600876aa14e9cbec8f8acd7d53b5f"

# =============================================================================
# R2 Bucket - For image and media storage
# =============================================================================
[[r2_buckets]]
binding = "IMAGES"
bucket_name = "grove-media"

# =============================================================================
# R2 Bucket - Source bucket for image migration
# =============================================================================
[[r2_buckets]]
binding = "IMAGES_SOURCE"
bucket_name = "autumnsgrove-images"

# =============================================================================
# R2 Bucket - Dedicated bucket for temporary export zip files
# =============================================================================
[[r2_buckets]]
binding = "EXPORTS_BUCKET"
bucket_name = "grove-exports"

# =============================================================================
# D1 Database - Main shared database for multi-tenant platform
# =============================================================================
# Uses the shared grove-engine-db for tenants, users, content, and auth
# Run migrations: npx wrangler d1 execute grove-engine-db --file=migrations/005_multi_tenant.sql --remote
[[d1_databases]]
binding = "DB"
database_name = "grove-engine-db"
database_id = "a6394da2-b7a6-48ce-b7fe-b1eb3e730e68"

# =============================================================================
# Workers AI - For Petal image moderation (Llama 4 Scout vision)
# =============================================================================
# Used by Petal content moderation system for image classification.
# Free tier: 10,000 neurons/day. Paid: $0.27/M input, $0.85/M output.
# @see docs/specs/petal-spec.md
[ai]
binding = "AI"

# =============================================================================
# GroveAuth Service Binding (Heartwood - fast session validation)
# =============================================================================
[[services]]
binding = "AUTH"
service = "groveauth"

# =============================================================================
# Zephyr Service Binding (email gateway - direct internal routing)
# =============================================================================
[[services]]
binding = "ZEPHYR"
service = "grove-zephyr"

# =============================================================================
# Durable Objects - Loom Pattern (Grove's coordination layer)
# =============================================================================
# DOs are hosted in the grove-durable-objects worker and referenced here.
# Deploy DO worker first: cd packages/durable-objects && pnpm deploy

# TenantDO: Per-tenant config caching, draft sync, analytics buffering
[[durable_objects.bindings]]
name = "TENANTS"
class_name = "TenantDO"
script_name = "grove-durable-objects"

# PostMetaDO: Per-post reactions, views, real-time presence (hot data)
[[durable_objects.bindings]]
name = "POST_META"
class_name = "PostMetaDO"
script_name = "grove-durable-objects"

# PostContentDO: Per-post content caching (warm data, hibernates quickly)
[[durable_objects.bindings]]
name = "POST_CONTENT"
class_name = "PostContentDO"
script_name = "grove-durable-objects"

# SentinelDO: Stress test coordination (long-running tests, WebSocket updates)
[[durable_objects.bindings]]
name = "SENTINEL"
class_name = "SentinelDO"
script_name = "grove-durable-objects"

# ExportDO: Per-export zip assembly job (alarm-based, long-running)
[[durable_objects.bindings]]
name = "EXPORTS"
class_name = "ExportDO"
script_name = "grove-durable-objects"

# NOTE: DO migrations are in the grove-durable-objects worker, not here.
# Pages projects reference external DOs via script_name.

# =============================================================================
# Environment Variables (non-sensitive)
# =============================================================================
[vars]
CACHE_TTL_SECONDS = "3600"
ZEPHYR_URL = "https://grove-zephyr.m7jv4v7npb.workers.dev"
GROVEAUTH_URL = "https://auth.grove.place"
# The Clearing (Status Page) - for Sentinel integration
CLEARING_API_URL = "https://status.grove.place"
# Turnstile (Shade) - human verification
# Get from: Cloudflare Dashboard → Turnstile → Your Widget
TURNSTILE_SITE_KEY = "0x4AAAAAACI9p49O_VFDy3WA"

# =============================================================================
# Envelope Encryption - Key Encryption Key (KEK)
# =============================================================================
# The KEK encrypts per-tenant DEKs (Data Encryption Keys).
# Set via wrangler secret put (NOT in this file - it's sensitive!).
#
# Setup commands (run via gw for consistency across services):
#   # Generate and set KEK:
#   gw secret generate GROVE_KEK
#   # OR if you have an existing key:
#   gw secret set GROVE_KEK
#   # (paste 64-char hex key when prompted)
#
#   # Apply to all services that need it:
#   gw secret apply GROVE_KEK --worker grove-lattice
#   gw secret apply GROVE_KEK --worker grove-timeline-sync
#
# Manual alternative:
#   # Generate KEK: openssl rand -hex 32
#   wrangler secret put GROVE_KEK
#
# IMPORTANT: Both grove-lattice and grove-timeline-sync share the same D1
# database, so they MUST use the exact same KEK value. Mismatched KEKs
# means one service can't decrypt secrets encrypted by the other.
#
# NOTE: GROVE_KEK is set as a regular Cloudflare secret because Pages
# doesn't support secrets_store_secrets bindings (only Workers do).

# =============================================================================
# Secrets (set via CLI, not in this file!)
# =============================================================================
# Required secrets - set with: npx wrangler secret put SECRET_NAME
#
# SESSION_SECRET     - Secret for signing JWT tokens (32+ random chars)
#                      Generate: openssl rand -hex 32
#
# ALLOWED_ADMIN_EMAILS - Comma-separated list of admin emails
#                        Example: "admin@example.com,owner@example.com"
#
# RESEND_API_KEY     - API key for Resend email service
#                      Get from: https://resend.com
#
# TURNSTILE_SECRET_KEY - Cloudflare Turnstile secret key (Shade)
#                        Get from: Cloudflare Dashboard → Turnstile
#
# =============================================================================
# GroveAuth Secrets (Heartwood OAuth)
# =============================================================================
# GROVEAUTH_CLIENT_ID     - OAuth client ID for this application
#                           Register at: login.grove.place
#
# GROVEAUTH_CLIENT_SECRET - OAuth client secret
#                           Keep this secure!
#
# =============================================================================
# Stripe Secrets (for Shop & Billing)
# =============================================================================
# STRIPE_SECRET_KEY  - Stripe secret key (sk_live_xxx or sk_test_xxx)
#                      Get from: https://dashboard.stripe.com/apikeys
#
# STRIPE_PUBLISHABLE_KEY - Stripe publishable key (pk_live_xxx or pk_test_xxx)
#                          Used in frontend for Stripe.js
#
# STRIPE_WEBHOOK_SECRET - Webhook signing secret (whsec_xxx)
#                         Get from: https://dashboard.stripe.com/webhooks
#
# STRIPE_CONNECT_ENABLED - Set to "true" to enable marketplace mode
#
# PLATFORM_FEE_PERCENT - Platform fee percentage for Connect (default: 5)
#
# =============================================================================
# Stripe Price IDs (for Platform Billing)
# =============================================================================
# Create these prices in Stripe Dashboard, then set:
#
# STRIPE_PRICE_SEEDLING     - Price ID for Seedling plan ($8/mo)
# STRIPE_PRICE_SAPLING      - Price ID for Sapling plan ($12/mo)
# STRIPE_PRICE_OAK          - Price ID for Oak plan ($25/mo)
# STRIPE_PRICE_EVERGREEN    - Price ID for Evergreen plan ($35/mo)

# =============================================================================
# Cloudflare Pages Notes
# =============================================================================
# - Cron triggers are NOT supported in Pages mode
# - Scheduled tasks use dedicated Workers (see below)
# - Assets are handled automatically by Pages
# - Custom domains configured in Cloudflare Dashboard
#
# =============================================================================
# Scheduled Tasks (Webhook Cleanup)
# =============================================================================
# Webhook cleanup runs via a dedicated Worker with cron trigger:
#
#   Worker: packages/workers/webhook-cleanup/
#   Schedule: Daily at 3:00 AM UTC (crons = ["0 3 * * *"])
#
# Deploy with:
#   cd packages/workers/webhook-cleanup && pnpm install && pnpm deploy
#
# The worker deletes webhook_events where expires_at < now()
# Retention period: 120 days (set by calculateWebhookExpiry in engine)
# =============================================================================
