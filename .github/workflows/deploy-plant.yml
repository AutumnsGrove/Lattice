name: Deploy Plant

on:
  push:
    branches: [main]
    paths:
      - "apps/plant/**"
      - "libs/engine/**"
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    uses: ./.github/workflows/_deploy-pages.yml
    with:
      app-dir: apps/plant
      project-name: grove-plant
      needs-engine: true
      run-tests: true
      checkout-ref: main
    secrets: inherit

  health-check:
    name: Stripe Health Check
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Check Stripe payments endpoint
        run: |
          for i in {1..6}; do
            STATUS=$(curl -s https://grove-plant.pages.dev/api/health/payments | jq -r '.status // "error"')
            if [ "$STATUS" != "error" ]; then break; fi
            echo "Waiting for deployment ($i/6)..."
            sleep 5
          done

          RESPONSE=$(curl -s https://grove-plant.pages.dev/api/health/payments)
          STATUS=$(echo "$RESPONSE" | jq -r '.status')
          echo "Health Check: $STATUS"
          echo "$RESPONSE" | jq '.checks'

          if [[ "$STATUS" != "healthy" && "$STATUS" != "degraded" ]]; then
            echo "::error::Deployment health check failed â€” Status: $STATUS"
            exit 1
          fi
          echo "Health check passed"
