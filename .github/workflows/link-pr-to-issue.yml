name: Link PR to Issue

on:
  pull_request:
    types: [opened, reopened, closed]

jobs:
  link-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
    
    steps:
      - name: Extract issue number and update status
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';
            const prTitle = pr.title || '';
            
            // Extract issue numbers from PR body/title (supports #123, fixes #123, closes #123, etc.)
            const issueRegex = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*#(\d+)|#(\d+)/gi;
            const matches = [...prBody.matchAll(issueRegex), ...prTitle.matchAll(issueRegex)];
            const issueNumbers = [...new Set(matches.map(m => m[1] || m[2]))];
            
            console.log(`Found linked issues: ${issueNumbers.join(', ')}`);
            
            for (const issueNumber of issueNumbers) {
              try {
                // Get current issue to check labels
                const issue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber)
                });
                
                if (pr.state === 'open') {
                  // PR opened/reopened - add in-progress label
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    labels: ['in-progress']
                  });
                  
                  // Remove 'ready' label if present
                  try {
                    await github.rest.issues.removeLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: parseInt(issueNumber),
                      name: 'ready'
                    });
                  } catch (e) {
                    // Label might not exist, that's fine
                  }
                  
                  // Comment on issue
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    body: `üöß Work in progress: #${pr.number}`
                  });
                  
                } else if (pr.merged) {
                  // PR merged - add completed label and comment
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    labels: ['completed']
                  });
                  
                  // Remove in-progress label
                  try {
                    await github.rest.issues.removeLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: parseInt(issueNumber),
                      name: 'in-progress'
                    });
                  } catch (e) {
                    // Label might not exist
                  }
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    body: `‚úÖ Completed in #${pr.number}`
                  });
                  
                } else if (pr.state === 'closed' && !pr.merged) {
                  // PR closed without merging - remove in-progress, add back ready
                  try {
                    await github.rest.issues.removeLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: parseInt(issueNumber),
                      name: 'in-progress'
                    });
                  } catch (e) {
                    // Label might not exist
                  }
                  
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    labels: ['ready']
                  });
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    body: `‚è∏Ô∏è PR #${pr.number} was closed without merging. Issue returned to ready state.`
                  });
                }
                
              } catch (error) {
                console.error(`Error processing issue #${issueNumber}: ${error.message}`);
              }
            }
