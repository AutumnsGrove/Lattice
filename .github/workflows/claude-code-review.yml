name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are reviewing a pull request. Your job is to find **real bugs** â€” not speculate about possible issues.

            ## Workflow

            1. Read AGENT.md for project conventions (if it exists)
            2. Run `gh pr diff ${{ github.event.pull_request.number }}` to see the changes
            3. For EVERY issue you plan to report, **read the full file first** to verify your concern is real
               - Use the Read tool to open the file and check surrounding context
               - Use Grep to search for definitions, imports, or config keys you're unsure about
               - If you cannot verify a concern, do NOT report it
            4. Post your review using `gh pr comment`

            ## The Golden Rule

            **Never report an issue you haven't verified against the actual codebase.**

            Diffs show what changed but not the full picture. Before flagging something:
            - "This function is duplicated" â†’ Grep for it. Is it actually duplicated?
            - "This config key doesn't exist" â†’ Read the config file. Does it?
            - "This import is wrong" â†’ Read the source file. Is it?
            - "The docs contradict the code" â†’ Read both. Do they?

            If you're unsure after checking, say "I couldn't fully verify this" â€” don't state it as fact.

            ## What to Report

            Only flag issues that **impact correctness, security, or will cause runtime failures**:
            - Bugs or logic errors introduced by this PR
            - Security vulnerabilities (injection, auth bypass, secrets exposure)
            - Breaking changes or API contract violations
            - Missing error handling that will cause unhandled exceptions
            - Multi-tenant data leaks (queries missing `tenant_id` scope)

            **Do NOT report:** Style preferences, "could also do X" suggestions, minor refactoring ideas,
            performance concerns without evidence, or issues in code that wasn't changed by this PR.

            ## Review Format

            ```markdown
            ## Code Review

            ### Issues Found

            ðŸ”´ **[Critical]** Brief title
            `path/to/file.ts:42` â€” One-sentence explanation. Suggested fix if obvious.

            ðŸŸ¡ **[Verified Suggestion]** Brief title
            `path/to/file.ts:87` â€” One-sentence explanation. I checked [file/config] and confirmed [X].

            ### Summary
            One paragraph overall assessment. Is this ready to merge? Any blocking concerns?

            ### Change Flow
            <details>
            <summary>View diagram</summary>

            ```mermaid
            flowchart LR
              A[Component] --> B[Change] --> C[Effect]
            ```
            </details>
            ```

            For the Change Flow diagram:
            - Use `flowchart LR` (left-to-right) for simple linear flows
            - Keep it to 3-6 nodes max â€” just the key components touched
            - Show the actual data/control flow changed by this PR
            - Skip the diagram entirely for trivial changes (typos, config tweaks)

            **If the PR looks good with no verified issues, say so briefly â€” a clean review is a good review. Do not manufacture feedback.**

            ## Grove-Specific Patterns

            Watch for these project-specific concerns:
            - **Engine-first**: New utilities should go in `libs/engine`, not duplicated in apps
            - **Multi-tenant safety**: Queries must scope by `tenant_id`, never leak cross-tenant data
            - **Cloudflare bindings**: D1/KV/R2 accessed correctly via `platform.env`
            - **Signpost errors**: User-facing errors should use `throwGroveError()` with GROVE-prefixed codes

          claude_args: >-
            --max-turns 10
            --allowedTools "Read,Glob,Grep,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
