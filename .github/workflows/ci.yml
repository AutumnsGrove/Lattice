name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  # ── Detect which packages are affected by the changes ────────────
  detect:
    name: Detect Affected
    runs-on: ubuntu-latest
    outputs:
      affected: ${{ steps.affected.outputs.packages }}
      test-matrix: ${{ steps.affected.outputs.test_matrix }}
      typecheck-matrix: ${{ steps.affected.outputs.typecheck_matrix }}
      needs-engine: ${{ steps.affected.outputs.needs_engine }}
      has-tests: ${{ steps.affected.outputs.has_tests }}
      has-typechecks: ${{ steps.affected.outputs.has_typechecks }}
      run-all: ${{ steps.affected.outputs.run_all }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect affected packages
        id: affected
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
          else
            BASE="HEAD~1"
          fi

          RESULT=$(node .github/scripts/affected-packages.mjs "$BASE")
          echo "Full result: $RESULT"

          PACKAGES=$(echo "$RESULT" | jq -c '.affectedPackages')
          TEST_MATRIX=$(echo "$RESULT" | jq -c '.testMatrix')
          TC_MATRIX=$(echo "$RESULT" | jq -c '.typecheckMatrix')
          NEEDS_ENGINE=$(echo "$RESULT" | jq -r '.needsEngine')
          RUN_ALL=$(echo "$RESULT" | jq -r '.runAll')
          HAS_TESTS=$(echo "$RESULT" | jq -r '.testMatrix | length > 0')
          HAS_TC=$(echo "$RESULT" | jq -r '.typecheckMatrix | length > 0')

          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "test_matrix=$TEST_MATRIX" >> $GITHUB_OUTPUT
          echo "typecheck_matrix=$TC_MATRIX" >> $GITHUB_OUTPUT
          echo "needs_engine=$NEEDS_ENGINE" >> $GITHUB_OUTPUT
          echo "has_tests=$HAS_TESTS" >> $GITHUB_OUTPUT
          echo "has_typechecks=$HAS_TC" >> $GITHUB_OUTPUT
          echo "run_all=$RUN_ALL" >> $GITHUB_OUTPUT

          # Summary for the Actions UI
          echo "### Affected Packages" >> $GITHUB_STEP_SUMMARY
          echo "$RESULT" | jq -r '.affectedPackages[]' | while read pkg; do
            echo "- \`$pkg\`" >> $GITHUB_STEP_SUMMARY
          done
          CHANGED=$(echo "$RESULT" | jq -r '.changedFiles')
          AFFECTED=$(echo "$RESULT" | jq -r '.affectedPackages | length')
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**$CHANGED files changed → $AFFECTED packages affected**" >> $GITHUB_STEP_SUMMARY

  # ── Run tests only for affected packages ─────────────────────────
  test:
    name: "Test: ${{ matrix.name }}"
    needs: detect
    if: needs.detect.outputs.has-tests == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.detect.outputs.test-matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup workspace
        uses: ./.github/actions/grove-setup
        with:
          build-engine: ${{ needs.detect.outputs.needs-engine }}

      - name: Sync SvelteKit
        if: matrix.isSvelteKit
        run: pnpm exec svelte-kit sync
        working-directory: ${{ matrix.package }}

      - name: Run tests
        run: pnpm test:run
        working-directory: ${{ matrix.package }}

  # ── Type check only affected packages ────────────────────────────
  typecheck:
    name: "Check: ${{ matrix.name }}"
    needs: detect
    if: needs.detect.outputs.has-typechecks == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.detect.outputs.typecheck-matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup workspace
        uses: ./.github/actions/grove-setup
        with:
          build-engine: ${{ needs.detect.outputs.needs-engine }}
          build-foliage: ${{ needs.detect.outputs.needs-engine }}

      - name: Sync SvelteKit
        if: matrix.isSvelteKit
        run: pnpm exec svelte-kit sync
        working-directory: ${{ matrix.package }}

      - name: Type check
        run: ${{ matrix.command }}
        working-directory: ${{ matrix.package }}

  # ── Barrel export verification (fast, always runs) ───────────────
  barrel-exports:
    name: Engine Barrel Exports
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify engine barrel exports
        run: ./tools/verify-engine-exports.sh

  # ── Lint (always runs, fast) ─────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup workspace
        uses: ./.github/actions/grove-setup

      - name: Run linters
        run: pnpm lint

      - name: Check formatting
        run: pnpm format:check

  # ── Summary gate — blocks merge if any job fails ─────────────────
  ci-pass:
    name: CI Pass
    if: always()
    needs: [detect, test, typecheck, barrel-exports, lint]
    runs-on: ubuntu-latest
    steps:
      - name: Check all jobs
        run: |
          echo "detect: ${{ needs.detect.result }}"
          echo "test: ${{ needs.test.result }}"
          echo "typecheck: ${{ needs.typecheck.result }}"
          echo "barrel-exports: ${{ needs.barrel-exports.result }}"
          echo "lint: ${{ needs.lint.result }}"

          # Fail if any required job failed
          if [[ "${{ needs.detect.result }}" == "failure" ]] || \
             [[ "${{ needs.test.result }}" == "failure" ]] || \
             [[ "${{ needs.typecheck.result }}" == "failure" ]] || \
             [[ "${{ needs.barrel-exports.result }}" == "failure" ]] || \
             [[ "${{ needs.lint.result }}" == "failure" ]]; then
            echo "::error::One or more CI jobs failed"
            exit 1
          fi

          echo "All CI checks passed"
