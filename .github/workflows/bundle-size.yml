name: Bundle Size Tracking

on:
  pull_request:
    branches: [main]
    paths:
      - "apps/landing/**"
      - "apps/clearing/**"
      - "apps/plant/**"
      - "libs/engine/**"
      - "libs/foliage/**"
      - "pnpm-lock.yaml"

  workflow_dispatch:

concurrency:
  group: bundle-size-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  bundle-size:
    name: Compare Bundle Sizes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: "**/pnpm-lock.yaml"

      - name: Install dependencies
        run: pnpm install

      - name: Build engine package
        run: pnpm run package
        working-directory: libs/engine

      - name: Build PR branch â€” landing
        run: pnpm run build
        working-directory: apps/landing

      - name: Measure PR bundle sizes
        id: pr-size
        run: |
          node .github/scripts/measure-bundle.mjs apps/landing/.svelte-kit/cloudflare > /tmp/pr-bundle.json
          echo "json=$(cat /tmp/pr-bundle.json)" >> $GITHUB_OUTPUT

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          clean: false
          path: __base

      - name: Build base branch â€” landing
        run: |
          cd __base
          pnpm install
          pnpm run package --filter @autumnsgrove/lattice || true
          cd apps/landing && pnpm run build || true

      - name: Measure base bundle sizes
        id: base-size
        run: |
          if [ -d "__base/apps/landing/.svelte-kit/cloudflare" ]; then
            node .github/scripts/measure-bundle.mjs __base/apps/landing/.svelte-kit/cloudflare > /tmp/base-bundle.json
            echo "json=$(cat /tmp/base-bundle.json)" >> $GITHUB_OUTPUT
          else
            echo 'json={"total":0,"files":{}}' >> $GITHUB_OUTPUT
          fi

      - name: Generate comparison comment
        id: comment
        uses: actions/github-script@v7
        env:
          PR_BUNDLE: ${{ steps.pr-size.outputs.json }}
          BASE_BUNDLE: ${{ steps.base-size.outputs.json }}
        with:
          script: |
            const pr = JSON.parse(process.env.PR_BUNDLE || '{"total":0,"files":{}}');
            const base = JSON.parse(process.env.BASE_BUNDLE || '{"total":0,"files":{}}');

            const formatBytes = (bytes) => {
              if (bytes === 0) return '0 B';
              const k = 1024;
              const sizes = ['B', 'KB', 'MB'];
              const i = Math.floor(Math.log(Math.abs(bytes) || 1) / Math.log(k));
              return `${(bytes / Math.pow(k, i)).toFixed(1)} ${sizes[i]}`;
            };

            const formatDiff = (current, previous) => {
              const diff = current - previous;
              if (previous === 0) return 'ðŸ†• new';
              if (diff === 0) return 'â€”';
              const pct = ((diff / previous) * 100).toFixed(1);
              const arrow = diff > 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';
              const sign = diff > 0 ? '+' : '';
              return `${arrow} ${sign}${formatBytes(diff)} (${sign}${pct}%)`;
            };

            const totalDiff = pr.total - base.total;
            const totalPct = base.total > 0
              ? ((totalDiff / base.total) * 100).toFixed(1)
              : 'n/a';

            let emoji = 'ðŸ“¦';
            if (totalDiff > 50 * 1024) emoji = 'ðŸš¨';      // > 50KB increase
            else if (totalDiff > 10 * 1024) emoji = 'âš ï¸';  // > 10KB increase
            else if (totalDiff < -1024) emoji = 'ðŸŽ‰';       // decrease
            else emoji = 'âœ…';                               // stable

            let body = `## ${emoji} Bundle Size Report\n\n`;

            // Summary line
            if (base.total === 0) {
              body += `**Total:** ${formatBytes(pr.total)} (no baseline to compare)\n\n`;
            } else {
              const sign = totalDiff > 0 ? '+' : '';
              body += `**Total:** ${formatBytes(pr.total)} `;
              body += `(${sign}${formatBytes(totalDiff)}, ${sign}${totalPct}% vs main)\n\n`;
            }

            // File breakdown table
            const allFiles = new Set([...Object.keys(pr.files), ...Object.keys(base.files)]);

            if (allFiles.size > 0) {
              body += '<details><summary>File breakdown</summary>\n\n';
              body += '| File | Base | PR | Change |\n';
              body += '| --- | ---: | ---: | --- |\n';

              const sorted = [...allFiles].sort((a, b) => {
                return (pr.files[b] || 0) - (pr.files[a] || 0);
              });

              for (const file of sorted) {
                const prSize = pr.files[file] || 0;
                const baseSize = base.files[file] || 0;
                if (prSize === 0 && baseSize === 0) continue;

                const shortName = file.replace(/^_app\/immutable\//, '');
                body += `| \`${shortName}\` | ${formatBytes(baseSize)} | ${formatBytes(prSize)} | ${formatDiff(prSize, baseSize)} |\n`;
              }

              body += '\n</details>\n';
            }

            // Budget warnings
            if (pr.total > 500 * 1024) {
              body += '\n> âš ï¸ **Total bundle exceeds 500 KB.** Consider code splitting or lazy loading.\n';
            }
            if (totalDiff > 50 * 1024) {
              body += '\n> ðŸš¨ **Bundle grew by more than 50 KB.** Please review what changed.\n';
            }

            core.setOutput('body', body);

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: ${{ steps.comment.outputs.body }}
        with:
          script: |
            const body = process.env.COMMENT_BODY;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Bundle Size Report')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Cleanup base checkout
        if: always()
        run: rm -rf __base
