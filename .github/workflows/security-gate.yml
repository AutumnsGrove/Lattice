name: Security Gate

on:
  pull_request:
    branches: [main]
    paths:
      - '**.svelte'
      - '**.ts'
      - '**.js'

jobs:
  semgrep:
    name: Semgrep Security Check
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan \
            --config=p/security-audit \
            --config=p/typescript \
            --config=p/xss \
            --config=p/jwt \
            --config=p/secrets \
            --config=p/svelte \
            --include='*.svelte' \
            --include='*.ts' \
            --include='*.js' \
            --exclude='node_modules' \
            --exclude='.svelte-kit' \
            --json --output=semgrep-gate-results.json

      - name: Check for high severity findings
        id: check-findings
        run: |
          if [ -f semgrep-gate-results.json ]; then
            HIGH_COUNT=$(cat semgrep-gate-results.json | jq '[.results[] | select(.extra.severity == "ERROR")] | length')
            echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT

            if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "❌ Found $HIGH_COUNT high severity issues"
              cat semgrep-gate-results.json | jq -r '
                .results[] | select(.extra.severity == "ERROR") |
                "=== Finding ===\nRule: \(.check_id)\nFile: \(.path):\(.start.line)\nMessage: \(.extra.message)"'
              echo "fail=true" >> $GITHUB_OUTPUT
            else
              echo "✅ No high severity issues found"
              echo "fail=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "✅ No scan results generated"
            echo "fail=false" >> $GITHUB_OUTPUT
          fi

      - name: Process findings and create issues
        if: steps.check-findings.outputs.fail == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract findings and process each
          cat semgrep-gate-results.json | jq -r '
            .results[] | select(.extra.severity == "ERROR") |
            @json' | while read -r finding; do
              CHECK_ID=$(echo "$finding" | jq -r '.check_id')
              FILE_PATH=$(echo "$finding" | jq -r '.path')
              LINE_NUM=$(echo "$finding" | jq -r '.start.line')
              MESSAGE=$(echo "$finding" | jq -r '.extra.message')
              SEVERITY="High"

              # Create fingerprint: SHA256 of file + line + rule
              FINGERPRINT=$(echo "${FILE_PATH}:${LINE_NUM}:${CHECK_ID}" | sha256sum | cut -d' ' -f1)

              # Check for existing issue with this fingerprint
              ISSUE_ID=$(gh issue list --label security --state open --json number,body -q '
                [.[] | select(.body | contains("'"$FINGERPRINT"'"))] | .[0].number' 2>/dev/null || echo "")

              ISSUE_TITLE="[${SEVERITY}] ${CHECK_ID}: ${MESSAGE:0:60}..."

              if [ -n "$ISSUE_ID" ] && [ "$ISSUE_ID" != "null" ]; then
                echo "Found duplicate issue #$ISSUE_ID, adding comment..."
                gh issue comment "$ISSUE_ID" --body "**New occurrence in PR:** ${FILE_PATH}:${LINE_NUM}
- Rule: ${CHECK_ID}
- Message: ${MESSAGE}

---
*Auto-generated by security-gate*"
              else
                echo "Creating new issue..."
                gh issue create \
                  --title "$ISSUE_TITLE" \
                  --body "## Security Finding

**Severity:** ${SEVERITY}
**Rule:** ${CHECK_ID}
**Location:** \`${FILE_PATH}:${LINE_NUM}\`

### Description
${MESSAGE}

### Fingerprint
\`${FINGERPRINT}\`

---
*Auto-generated by security-gate workflow*" \
                  --label "security,severity/high,sast"
              fi
            done

      - name: Fail if high severity issues found
        if: steps.check-findings.outputs.fail == 'true'
        run: exit 1

  codeql:
    name: CodeQL Security Check
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          build-mode: none

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"
          upload: always

  pass:
    name: Security Check Passed
    runs-on: ubuntu-latest
    needs: [semgrep, codeql]
    steps:
      - run: echo "✅ All security checks passed!"
