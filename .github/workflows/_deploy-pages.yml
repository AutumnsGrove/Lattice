# Reusable workflow for deploying Cloudflare Pages apps.
#
# Each Pages app (landing, plant, amber, etc.) calls this with its own
# parameters. The calling workflow still appears as its own entry in the
# Actions tab with full step-level logs — zero observability loss.
#
# NOTE: Reusable workflows cannot use local composite actions (like
# grove-setup) because GitHub pre-validates action references before
# checkout. Setup steps are inlined here instead.
#
# Usage (thin shim):
#   jobs:
#     deploy:
#       uses: ./.github/workflows/_deploy-pages.yml
#       with:
#         app-dir: apps/landing
#         project-name: grove-landing
#       secrets: inherit

name: _Deploy Pages App

on:
  workflow_call:
    inputs:
      app-dir:
        description: "App directory relative to repo root (e.g. apps/landing)"
        required: true
        type: string
      project-name:
        description: "Cloudflare Pages project name (e.g. grove-landing)"
        required: true
        type: string
      needs-engine:
        description: "Build libs/engine before deploying"
        required: false
        type: boolean
        default: true
      needs-foliage:
        description: "Build libs/foliage before engine"
        required: false
        type: boolean
        default: false
      run-typecheck:
        description: "Run type checking"
        required: false
        type: boolean
        default: true
      run-tests:
        description: "Run tests before deploying"
        required: false
        type: boolean
        default: false
      test-command:
        description: "Test command to run (default: pnpm test:run)"
        required: false
        type: string
        default: "pnpm test:run"
      run-migrations:
        description: "Run D1 database migrations before deploying"
        required: false
        type: boolean
        default: false
      migration-db:
        description: "D1 database name for migrations"
        required: false
        type: string
        default: ""
      checkout-ref:
        description: "Git ref to checkout (default: triggering ref)"
        required: false
        type: string
        default: ""

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      # ── Inline grove-setup (can't use composite action in reusable workflow) ──
      - name: Checkout
        if: inputs.checkout-ref == ''
        uses: actions/checkout@v4

      - name: Checkout (specific ref)
        if: inputs.checkout-ref != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout-ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: "**/pnpm-lock.yaml"

      - name: Install dependencies
        run: pnpm install

      - name: Build foliage
        if: inputs.needs-foliage
        run: pnpm run build
        working-directory: libs/foliage

      - name: Build engine
        if: inputs.needs-engine
        run: pnpm run package
        working-directory: libs/engine

      # ── App build & deploy ──────────────────────────────────────────────
      - name: Type check
        if: inputs.run-typecheck
        run: pnpm check
        working-directory: ${{ inputs.app-dir }}

      - name: Build
        run: pnpm run build
        working-directory: ${{ inputs.app-dir }}

      - name: Run tests
        if: inputs.run-tests
        run: ${{ inputs.test-command }}
        working-directory: ${{ inputs.app-dir }}

      - name: Run database migrations
        if: inputs.run-migrations
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 migrations apply ${{ inputs.migration-db }} --remote
          workingDirectory: ${{ inputs.app-dir }}
          packageManager: pnpm

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy .svelte-kit/cloudflare --project-name=${{ inputs.project-name }}
          workingDirectory: ${{ inputs.app-dir }}
          packageManager: pnpm
