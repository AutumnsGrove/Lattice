name: Auto-release Grove Tools

# Automatically patch-bump and release gw/gf when Go code changes on main.
# Detects which tool(s) changed, finds latest tag, increments patch, creates
# the new tag, then calls release-tools.yml to build + publish the release.

on:
  push:
    branches: [main]
    paths:
      - "tools/grove-wrap-go/**/*.go"
      - "tools/grove-wrap-go/go.mod"
      - "tools/grove-wrap-go/go.sum"
      - "tools/grove-find-go/**/*.go"
      - "tools/grove-find-go/go.mod"
      - "tools/grove-find-go/go.sum"

permissions:
  contents: write

jobs:
  # ============================================
  # DETECT - Which tool(s) changed?
  # ============================================
  detect:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      gw_changed: ${{ steps.changes.outputs.gw }}
      gf_changed: ${{ steps.changes.outputs.gf }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check changed paths
        id: changes
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD)

          if echo "$CHANGED" | grep -q "^tools/grove-wrap-go/"; then
            echo "gw=true" >> $GITHUB_OUTPUT
            echo "gw changed"
          else
            echo "gw=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED" | grep -q "^tools/grove-find-go/"; then
            echo "gf=true" >> $GITHUB_OUTPUT
            echo "gf changed"
          else
            echo "gf=false" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # BUMP GW - Auto-patch gw if changed
  # ============================================
  bump-gw:
    name: Bump GW Version
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.gw_changed == 'true'
    outputs:
      tag: ${{ steps.bump.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Test
        working-directory: tools/grove-wrap-go
        run: go test ./... && go vet ./...

      - name: Bump patch version
        id: bump
        run: |
          # Find latest gw tag
          LATEST=$(git tag -l 'gw/v*' --sort=-v:refname | head -1)
          if [ -z "$LATEST" ]; then
            LATEST="gw/v0.0.0"
          fi
          echo "Latest tag: $LATEST"

          # Parse version: gw/v1.0.0 → 1.0.0
          VER="${LATEST#gw/v}"
          MAJOR=$(echo "$VER" | cut -d. -f1)
          MINOR=$(echo "$VER" | cut -d. -f2)
          PATCH=$(echo "$VER" | cut -d. -f3)

          # Bump patch
          NEW_PATCH=$((PATCH + 1))
          NEW_TAG="gw/v${MAJOR}.${MINOR}.${NEW_PATCH}"
          echo "Bumping: $LATEST → $NEW_TAG"

          # Create and push tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$NEW_TAG" -m "gw v${MAJOR}.${MINOR}.${NEW_PATCH} (auto-release)"
          git push origin "$NEW_TAG"

          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

  # ============================================
  # BUMP GF - Auto-patch gf if changed
  # ============================================
  bump-gf:
    name: Bump GF Version
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.gf_changed == 'true'
    outputs:
      tag: ${{ steps.bump.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Test
        working-directory: tools/grove-find-go
        run: go test ./... && go vet ./...

      - name: Bump patch version
        id: bump
        run: |
          # Find latest gf tag
          LATEST=$(git tag -l 'gf/v*' --sort=-v:refname | head -1)
          if [ -z "$LATEST" ]; then
            LATEST="gf/v0.0.0"
          fi
          echo "Latest tag: $LATEST"

          # Parse version: gf/v1.0.0 → 1.0.0
          VER="${LATEST#gf/v}"
          MAJOR=$(echo "$VER" | cut -d. -f1)
          MINOR=$(echo "$VER" | cut -d. -f2)
          PATCH=$(echo "$VER" | cut -d. -f3)

          # Bump patch
          NEW_PATCH=$((PATCH + 1))
          NEW_TAG="gf/v${MAJOR}.${MINOR}.${NEW_PATCH}"
          echo "Bumping: $LATEST → $NEW_TAG"

          # Create and push tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$NEW_TAG" -m "gf v${MAJOR}.${MINOR}.${NEW_PATCH} (auto-release)"
          git push origin "$NEW_TAG"

          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

  # ============================================
  # RELEASE GW - Build + publish via reusable workflow
  # ============================================
  release-gw:
    name: Release GW
    needs: bump-gw
    if: needs.bump-gw.outputs.tag != ''
    uses: ./.github/workflows/release-tools.yml
    with:
      tag: ${{ needs.bump-gw.outputs.tag }}

  # ============================================
  # RELEASE GF - Build + publish via reusable workflow
  # ============================================
  release-gf:
    name: Release GF
    needs: bump-gf
    if: needs.bump-gf.outputs.tag != ''
    uses: ./.github/workflows/release-tools.yml
    with:
      tag: ${{ needs.bump-gf.outputs.tag }}
