name: Auto-tag on Version Bump

on:
  push:
    branches:
      - main
    paths:
      - 'packages/engine/package.json'
  workflow_dispatch:
    inputs:
      force_snapshot:
        description: 'Force snapshot generation even without version change'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write

jobs:
  tag-and-snapshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate commit count

      - name: Check for version change
        id: version
        run: |
          # Get current version
          CURRENT=$(jq -r '.version' packages/engine/package.json)
          echo "current=$CURRENT" >> $GITHUB_OUTPUT

          # Get previous version
          git show HEAD~1:packages/engine/package.json > /tmp/prev-package.json 2>/dev/null || echo '{"version":"0.0.0"}' > /tmp/prev-package.json
          PREVIOUS=$(jq -r '.version' /tmp/prev-package.json)
          echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT

          # Check if changed
          if [ "$CURRENT" != "$PREVIOUS" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Version changed: $PREVIOUS â†’ $CURRENT"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Version unchanged: $CURRENT"
          fi

      - name: Check if tag exists
        id: tag_exists
        if: steps.version.outputs.changed == 'true'
        run: |
          TAG="v${{ steps.version.outputs.current }}"
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG does not exist"
          fi

      - name: Create and push tag
        id: create_tag
        if: steps.version.outputs.changed == 'true' && steps.tag_exists.outputs.exists == 'false'
        run: |
          TAG="v${{ steps.version.outputs.current }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "tag_name=$TAG" >> $GITHUB_OUTPUT
          echo "Created and pushed tag: $TAG"

      - name: Generate repository snapshot
        id: snapshot
        if: (steps.version.outputs.changed == 'true' && steps.tag_exists.outputs.exists == 'false') || github.event.inputs.force_snapshot == 'true'
        run: |
          TAG="${{ steps.create_tag.outputs.tag_name || format('v{0}', steps.version.outputs.current) }}"
          echo "Generating snapshot for: $TAG"

          chmod +x ./scripts/repo-snapshot.sh
          ./scripts/repo-snapshot.sh "$TAG"

          echo "tag_name=$TAG" >> $GITHUB_OUTPUT

      - name: Generate release summary
        id: summary
        if: steps.snapshot.outcome == 'success'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          TAG="${{ steps.snapshot.outputs.tag_name }}"
          echo "Generating release summary for: $TAG"

          # Make script executable
          chmod +x ./scripts/generate-release-summary.sh

          # Generate summary (will use previous tag automatically)
          ./scripts/generate-release-summary.sh "$TAG" || echo "Warning: Summary generation failed, continuing..."

      - name: Sync data to landing page
        if: steps.snapshot.outcome == 'success'
        run: |
          # Ensure landing data directory exists
          mkdir -p landing/static/data

          # Copy the history CSV so the /journey page can display it
          cp snapshots/history.csv landing/static/data/history.csv

          # Copy release summaries so the /roadmap page can display them
          if [ -d snapshots/summaries ]; then
            mkdir -p landing/static/data/summaries
            cp -r snapshots/summaries/* landing/static/data/summaries/ 2>/dev/null || echo "No summaries to copy"
          fi

      - name: Commit and push snapshot
        if: steps.snapshot.outcome == 'success'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add snapshot files, summaries, and landing data
          git add snapshots/ landing/static/data/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "docs: add repository snapshot and release summary for ${{ steps.snapshot.outputs.tag_name }}"
          git push origin main
